<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STUDIO_PRO // Rhythm Architect</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #020406; --panel: rgba(15, 20, 30, 0.9); --blue: #4facfe; 
            --gold: #ffcc00; --red: #ff4b2b; --border: rgba(79, 172, 254, 0.2); --green: #00ff88; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; background: var(--bg); color: #fff; font-family: 'Orbitron', sans-serif; 
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            background-image: radial-gradient(circle at 0% 0%, rgba(79, 172, 254, 0.1) 0%, transparent 40%);
            padding: env(safe-area-inset-top) 10px 40px 10px;
        }

        /* --- Header --- */
        header {
            width: 100%; max-width: 1100px; padding: 15px 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-title h1 { margin: 0; font-size: 1rem; color: var(--blue); letter-spacing: 2px; }
        .btn-exit { text-decoration: none; color: #888; font-size: 0.6rem; border: 1px solid #333; padding: 6px 12px; border-radius: 6px; transition: 0.3s; }
        .btn-exit:hover { color: #fff; border-color: var(--blue); }

        /* --- Main DAW Container --- */
        .daw-container { 
            width: 100%; max-width: 1100px; background: var(--panel); 
            border: 1px solid var(--border); border-radius: 20px; padding: 20px;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        /* --- Top Deck --- */
        .top-deck { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px; }
        @media (min-width: 850px) { .top-deck { grid-template-columns: 1fr 2fr 1fr; } }
        
        .vocal-unit { 
            background: rgba(0,0,0,0.3); border: 1px solid var(--red); padding: 15px; border-radius: 12px;
            display: flex; flex-direction: column; gap: 8px;
        }
        select { background: #000; color: var(--red); border: 1px solid #444; padding: 10px; font-family: 'Orbitron'; font-size: 0.7rem; border-radius: 6px; width: 100%; }

        .visualizer-box { background: #000; border: 1px solid var(--blue); height: 80px; border-radius: 10px; overflow: hidden; }

        .btn-rec { 
            border: 1px solid var(--red); color: var(--red); background: rgba(255, 75, 43, 0.05); 
            font-family: 'Orbitron'; font-size: 0.8rem; font-weight: 700; cursor: pointer; border-radius: 12px; transition: 0.3s;
        }
        .btn-rec.on { background: var(--red); color: #000; animation: blink 1s infinite; }

        /* --- Sequencer Grid (Mobile Scrolling) --- */
        .sequencer-wrapper { width: 100%; overflow-x: auto; padding-bottom: 15px; margin: 10px 0; scrollbar-width: thin; }
        .track-row { 
            display: flex; align-items: center; margin-bottom: 8px; gap: 10px; 
            background: rgba(255,255,255,0.02); padding: 12px; border-radius: 12px; min-width: 800px;
        }

        .track-info { width: 150px; flex-shrink: 0; }
        .track-label { font-size: 0.65rem; color: var(--blue); margin-bottom: 8px; font-weight: 700; }
        .vol-slider { -webkit-appearance: none; width: 100%; height: 4px; background: #333; border-radius: 2px; }
        .vol-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: var(--gold); border-radius: 50%; border: 2px solid #000; }

        .step-grid { display: grid; grid-template-columns: repeat(16, 1fr); gap: 6px; flex-grow: 1; }
        .step { 
            aspect-ratio: 1/1; background: #080a0f; border: 1px solid #1a1a1a; 
            cursor: pointer; border-radius: 5px; transition: 0.1s;
        }
        .step.active { background: var(--blue); box-shadow: 0 0 12px var(--blue); border-color: #fff; }
        .step.playing { border: 2px solid var(--gold); transform: scale(1.1); z-index: 5; }

        /* --- Footer --- */
        .controls-footer {
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            gap: 20px; border-top: 1px solid #222; padding-top: 25px;
        }
        .btn-play { 
            padding: 15px 40px; font-family: 'Orbitron'; font-size: 0.9rem; font-weight: 900; 
            cursor: pointer; border: 1px solid var(--green); background: rgba(0, 255, 136, 0.05); color: var(--green); border-radius: 50px;
            transition: 0.3s; flex-grow: 1; max-width: 350px;
        }
        .btn-play:hover { background: var(--green); color: #000; }

        .btn-load { font-size: 0.55rem; color: var(--gold); border: 1px solid; padding: 4px 10px; border-radius: 4px; cursor: pointer; text-transform: uppercase; }
        input[type="file"] { display: none; }

        /* --- Mission Briefing Overlay --- */
        #mission-briefing {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(2, 4, 6, 0.98); z-index: 9999; display: flex; align-items: center; justify-content: center;
            padding: 20px; transition: 0.5s;
        }
        .briefing-card {
            background: rgba(10, 15, 25, 0.9); border: 1px solid var(--blue); border-radius: 24px;
            max-width: 500px; width: 100%; padding: 40px; text-align: center; box-shadow: 0 0 50px rgba(79, 172, 254, 0.2);
        }
        .briefing-card h2 { font-size: 1.2rem; margin-bottom: 20px; color: #fff; }
        .briefing-text { text-align: left; font-size: 0.85rem; line-height: 1.6; color: #aaa; margin-bottom: 30px; }
        .briefing-text b { color: var(--green); }
        .btn-accept { 
            background: var(--blue); color: #000; border: none; padding: 15px 40px; 
            font-family: 'Orbitron'; font-weight: 900; border-radius: 8px; cursor: pointer; width: 100%; 
        }

        @keyframes blink { 50% { opacity: 0.4; } }
    </style>
</head>
<body>

<div id="mission-briefing">
    <div class="briefing-card">
        <div style="font-size: 0.6rem; color: var(--blue); letter-spacing: 5px; margin-bottom: 15px;">SYSTEM_GUIDE // ACTIVE</div>
        <h2>WELCOME TO RHYTHM_ARCHITECT</h2>
        <div class="briefing-text">
            <p><b>THE PURPOSE:</b> This is a professional-grade Neural Sequencer. You are here to build complex rhythm patterns that train your "Internal Clock."</p>
            <p><b>THE TRAINING:</b> Load your own sounds or use the system defaults. Toggle the grid steps to create a beat. Use <b>VOCAL_FX</b> to process your voice in real-time.</p>
            <p><b>THE REWARD:</b> Mastering this studio translates directly to real-world music production skills. Record your session to export your work as a pro audio file.</p>
        </div>
        <button class="btn-accept" onclick="closeBriefing()">INITIALIZE_STUDIO</button>
    </div>
</div>

<header>
    <div class="header-title"><h1>RHYTHM_ARCHITECT</h1></div>
    <a href="rhythm_hub.html" class="btn-exit">RETURN_TO_HUB</a>
</header>

<div class="daw-container">
    <div class="top-deck">
        <div class="vocal-unit">
            <div style="font-size: 0.55rem; color: var(--red); letter-spacing: 2px; margin-bottom: 5px;">NEURAL_MIC // FX</div>
            <select id="vocal-preset" onchange="applyVocalPreset(this.value)">
                <option value="dry">DRY_SIGNAL</option>
                <option value="radio">VINTAGE_RADIO</option>
                <option value="hall">GRAND_HALL</option>
                <option value="robot">ROBOTIC_SYNC</option>
            </select>
            <div id="midi-info" style="font-size: 0.5rem; color: var(--gold); margin-top: 5px;">üéπ MIDI_READY</div>
        </div>
        <div class="visualizer-box"><canvas id="visualizer"></canvas></div>
        <button class="btn-rec" id="rec-btn" onclick="toggleRecording()">‚óè REC_SESSION</button>
    </div>

    
    <div class="sequencer-wrapper">
        <div id="sequencer-grid"></div>
    </div>

    <div class="controls-footer">
        <button class="btn-play" id="play-btn" onclick="togglePlay()">PLAY_SEQUENCE</button>
        <div>
            <div style="font-size: 0.65rem; color: var(--blue); margin-bottom: 8px; text-align: right;">TEMPO: <span id="bpm-display">120</span> BPM</div>
            <input type="range" id="bpm-slider" min="60" max="200" value="120" oninput="updateTempo(this.value)" style="width:160px">
        </div>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const masterBus = audioCtx.createMediaStreamDestination();
    const analyzer = audioCtx.createAnalyser();
    analyzer.fftSize = 512;
    
    const trackNames = ["KICK", "SNARE", "HI_HAT", "SYNTH_L", "SYNTH_H"];
    let sampleBuffers = [null, null, null, null, null];
    let trackVolumes = [0.8, 0.7, 0.5, 0.5, 0.5];
    let grid = Array(5).fill().map(() => Array(16).fill(false));
    
    let isPlaying = false, currentStep = 0, nextNoteTime = 0, tempo = 120;
    let micStream, vocalChain, rec, chunks = [];

    // --- MIDI Input Handling ---
    if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess().then(access => {
            access.inputs.forEach(input => {
                input.onmidimessage = (m) => { if(m.data[0] === 144 && m.data[2] > 0) playMidi(m.data[1], m.data[2]); };
            });
        });
    }

    function playMidi(note, vel) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.frequency.value = 440 * Math.pow(2, (note - 69) / 12);
        g.gain.setTargetAtTime((vel/127) * 0.3, audioCtx.currentTime, 0.01);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1);
        osc.connect(g).connect(audioCtx.destination);
        osc.connect(g).connect(masterBus);
        osc.connect(g).connect(analyzer);
        osc.start(); osc.stop(audioCtx.currentTime + 1);
    }

    // --- Audio Logic ---
    async function loadSample(idx, file) {
        const buffer = await audioCtx.decodeAudioData(await file.arrayBuffer());
        sampleBuffers[idx] = buffer;
        document.getElementById(`label-${idx}`).style.color = "var(--green)";
    }

    async function applyVocalPreset(p) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        if (!micStream) micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const src = audioCtx.createMediaStreamSource(micStream);
        if (vocalChain) vocalChain.disconnect();
        vocalChain = audioCtx.createGain();
        
        if (p === 'radio') {
            const f = audioCtx.createBiquadFilter(); f.type = 'bandpass'; f.frequency.value = 1500;
            src.connect(f).connect(vocalChain);
        } else if (p === 'hall') {
            const d = audioCtx.createDelay(); d.delayTime.value = 0.3;
            src.connect(d).connect(vocalChain); src.connect(vocalChain);
        } else if (p === 'robot') {
            const osc = audioCtx.createOscillator(); osc.type = 'sawtooth'; osc.frequency.value = 50;
            const mod = audioCtx.createGain(); src.connect(mod.gain); osc.connect(mod).connect(vocalChain);
            osc.start();
        } else src.connect(vocalChain);

        vocalChain.connect(audioCtx.destination); vocalChain.connect(masterBus); vocalChain.connect(analyzer);
    }

    function init() {
        const seq = document.getElementById('sequencer-grid');
        trackNames.forEach((name, i) => {
            const row = document.createElement('div');
            row.className = 'track-row';
            row.innerHTML = `
                <div class="track-info">
                    <div class="track-label" id="label-${i}">${name}</div>
                    <input type="range" class="vol-slider" min="0" max="1" step="0.01" value="${trackVolumes[i]}" oninput="trackVolumes[${i}]=this.value">
                    <div style="display:flex; gap:10px; margin-top:8px;">
                        <label class="btn-load" for="up-${i}">LOAD</label>
                        <input type="file" id="up-${i}" accept="audio/*" onchange="loadSample(${i}, this.files[0])">
                    </div>
                </div>
                <div class="step-grid" id="grid-${i}"></div>
            `;
            const sGrid = row.querySelector(`#grid-${i}`);
            for(let s=0; s<16; s++) {
                const btn = document.createElement('div'); btn.className = 'step';
                btn.onclick = () => { grid[i][s] = !grid[i][s]; btn.classList.toggle('active'); };
                sGrid.appendChild(btn);
            }
            seq.appendChild(row);
        });
        drawVisualizer();
    }

    function triggerSound(idx, time) {
        if (sampleBuffers[idx]) {
            const src = audioCtx.createBufferSource();
            src.buffer = sampleBuffers[idx];
            const g = audioCtx.createGain();
            g.gain.setValueAtTime(trackVolumes[idx], time);
            src.connect(g).connect(audioCtx.destination);
            src.connect(g).connect(masterBus);
            src.connect(g).connect(analyzer);
            src.start(time);
        } else {
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.frequency.setValueAtTime(idx === 0 ? 60 : (idx === 1 ? 220 : 880 + idx*100), time);
            if(idx === 0) osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.3);
            g.gain.setValueAtTime(trackVolumes[idx]*0.3, time);
            g.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
            osc.connect(g).connect(audioCtx.destination);
            osc.connect(g).connect(masterBus);
            osc.connect(g).connect(analyzer);
            osc.start(time); osc.stop(time + 0.2);
        }
    }

    function scheduler() {
        while (nextNoteTime < audioCtx.currentTime + 0.1) {
            for(let i=0; i<5; i++) { if(grid[i][currentStep]) triggerSound(i, nextNoteTime); }
            visualStep(currentStep);
            nextNoteTime += (60 / tempo / 4);
            currentStep = (currentStep + 1) % 16;
        }
        if (isPlaying) setTimeout(scheduler, 25);
    }

    function visualStep(s) {
        document.querySelectorAll('.step').forEach(el => el.classList.remove('playing'));
        document.querySelectorAll('.track-row').forEach(r => {
            const stepEl = r.querySelector(`.step:nth-child(${s+1})`);
            if(stepEl) stepEl.classList.add('playing');
        });
    }

    function togglePlay() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        isPlaying = !isPlaying;
        document.getElementById('play-btn').innerText = isPlaying ? "STOP_ENGINE" : "PLAY_SEQUENCE";
        if (isPlaying) { currentStep = 0; nextNoteTime = audioCtx.currentTime; scheduler(); }
    }

    function toggleRecording() {
        const btn = document.getElementById('rec-btn');
        if (rec?.state === 'recording') {
            rec.stop(); btn.innerText = "‚óè REC_SESSION"; btn.classList.remove('on');
        } else {
            chunks = []; rec = new MediaRecorder(masterBus.stream);
            rec.ondataavailable = e => chunks.push(e.data);
            rec.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); 
                a.download = 'ninja_track_' + Date.now() + '.webm'; a.click();
            };
            rec.start(); btn.innerText = "RECORDING..."; btn.classList.add('on');
        }
    }

    function drawVisualizer() {
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        const data = new Uint8Array(analyzer.frequencyBinCount);
        function render() {
            requestAnimationFrame(render); analyzer.getByteTimeDomainData(data);
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.strokeStyle = 'var(--blue)'; ctx.lineWidth = 2; ctx.beginPath();
            let sliceWidth = canvas.width / data.length; let x = 0;
            for(let i=0; i<data.length; i++) {
                let v = data[i]/128.0; let y = v * (canvas.height/2);
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                x += sliceWidth;
            }
            ctx.stroke();
        }
        render();
    }

    function updateTempo(v) { tempo = v; document.getElementById('bpm-display').innerText = v; }
    
    function closeBriefing() {
        document.getElementById('mission-briefing').style.opacity = '0';
        setTimeout(() => document.getElementById('mission-briefing').style.display = 'none', 500);
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    window.onload = () => {
        const canvas = document.getElementById('visualizer');
        canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
        init();
    };
</script>
</body>
</html>
