<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonic Calibration | Psalmist Ninja</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #030508; --panel: #0a111a; --blue: #4facfe; 
            --gold: #ffcc00; --green: #00ff88; --border: #1e2544; --red: #ff4b2b;
        }
        body { 
            margin: 0; background: var(--bg); color: #fff; font-family: 'Orbitron', sans-serif; 
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
            background-image: radial-gradient(circle at center, #0b1426 0%, #030508 100%);
        }

        /* --- HUD --- */
        .hud-top {
            display: flex; justify-content: space-between; align-items: center; padding: 15px 40px;
            font-size: 0.65rem; letter-spacing: 3px; border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.3);
        }

        .main-stage { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        
        /* --- Toggles & Config --- */
        .controls-row { display: flex; gap: 20px; margin-bottom: 25px; }
        .config-box { background: rgba(255,255,255,0.05); padding: 10px 15px; border: 1px solid var(--border); display: flex; align-items: center; gap: 10px; border-radius: 4px; }
        .config-box label { font-size: 0.55rem; color: var(--blue); letter-spacing: 1px; }
        
        .toggle-btn { 
            background: #111; border: 1px solid var(--border); color: #555; 
            padding: 8px 15px; font-family: 'Orbitron'; font-size: 0.6rem; cursor: pointer; 
        }
        .toggle-btn.active { border-color: var(--gold); color: var(--gold); background: rgba(255, 204, 0, 0.05); }

        /* --- View Containers --- */
        .view-container { width: 100%; display: flex; justify-content: center; min-height: 180px; }
        .hidden { display: none !important; }

        /* Screen View */
        .viz-window {
            width: 700px; height: 150px; background: rgba(0,0,0,0.6); border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center; border-radius: 8px;
        }
        .pulse-light { width: 18px; height: 18px; border-radius: 50%; background: var(--blue); margin: 0 15px; opacity: 0.05; transition: 0.1s; }
        .pulse-light.active { opacity: 1; box-shadow: 0 0 20px var(--blue); background: #fff; }

        /* Piano View */
        .piano-view { display: flex; gap: 2px; background: #000; padding: 20px; border-radius: 8px; border: 1px solid var(--border); }
        .key { width: 35px; height: 120px; background: #ddd; border-radius: 0 0 4px 4px; position: relative; }
        .key.black { background: #222; width: 24px; height: 75px; margin-left: -12px; margin-right: -12px; z-index: 2; border: 1px solid #000; }
        .key.active { background: var(--blue) !important; box-shadow: 0 0 20px var(--blue); }

        /* --- Choices --- */
        .choices-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 550px; margin-top: 30px; }
        .choice-btn { 
            background: rgba(10, 17, 26, 0.8); border: 1px solid var(--border); color: #fff; padding: 18px;
            font-family: 'Orbitron'; font-size: 0.75rem; cursor: pointer; transition: 0.2s;
        }
        .choice-btn.success { background: var(--green) !important; color: #000; }
        .choice-btn.fail { background: var(--red) !important; opacity: 0.5; }

        .action-btns { margin-top: 30px; display: flex; gap: 20px; }
        .btn-main { background: var(--blue); color: #000; border: none; padding: 15px 40px; font-family: 'Orbitron'; font-weight: 900; cursor: pointer; border-radius: 4px; }
        .btn-stop { background: #1a1a1a; color: #666; border: 1px solid #333; padding: 15px 40px; font-family: 'Orbitron'; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="hud-top">
        <div>PROTOCOL_03: MODAL_LOGIC</div>
        <div id="global-xp">XP: 01685</div>
        <a href="pitch_hub.html" style="color: var(--blue); text-decoration: none;">[ EXIT ]</a>
    </div>

    <div class="main-stage">
        
        <div class="controls-row">
            <div class="config-box">
                <label>INTERFACE_VIEW:</label>
                <button class="toggle-btn active" id="view-screen" onclick="setView('screen')">SCREEN</button>
                <button class="toggle-btn" id="view-piano" onclick="setView('piano')">PIANO</button>
            </div>

            <div class="config-box">
                <label>COACH_MODE:</label>
                <button class="toggle-btn" id="coach-toggle" onclick="toggleCoach()">OFF</button>
            </div>

            <div class="config-box">
                <label>OPTIONS:</label>
                <select id="choiceCount" style="background:#000; color:#fff; border:1px solid var(--border); font-family:Orbitron; font-size:0.6rem;">
                    <option value="2">2</option>
                    <option value="4" selected>4</option>
                    <option value="7">7</option>
                </select>
            </div>
        </div>

        <div class="view-container">
            <div class="viz-window" id="screen-display">
                <div class="pulse-light"></div>
                <div class="pulse-light"></div>
                <div class="pulse-light"></div>
                <div class="pulse-light"></div>
                <div class="pulse-light"></div>
                <div class="pulse-light"></div>
                <div class="pulse-light"></div>
            </div>

            <div class="piano-view hidden" id="piano-display"></div>
        </div>

        <div class="choices-grid" id="choices-container"></div>

        <div class="action-btns">
            <button class="btn-main" id="startBtn" onclick="startTest()">INITIALIZE_SIGNAL</button>
            <button class="btn-stop" onclick="stopTest()">STOP_SIGNAL</button>
        </div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let playInterval, isPlaying = false, coachMode = false, currentView = 'screen';
        let currentModalName = "", currentSequence = [];

        const MODES = {
            "IONIAN": [0, 2, 4, 5, 7, 9, 11], "DORIAN": [0, 2, 3, 5, 7, 9, 10],
            "PHRYGIAN": [0, 1, 3, 5, 7, 8, 10], "LYDIAN": [0, 2, 4, 6, 7, 9, 11],
            "MIXOLYDIAN": [0, 2, 4, 5, 7, 9, 10], "AEOLIAN": [0, 2, 3, 5, 7, 8, 10], "LOCRIAN": [0, 1, 3, 5, 6, 8, 10]
        };

        function setView(view) {
            currentView = view;
            document.getElementById('view-screen').classList.toggle('active', view === 'screen');
            document.getElementById('view-piano').classList.toggle('active', view === 'piano');
            document.getElementById('screen-display').classList.toggle('hidden', view !== 'screen');
            document.getElementById('piano-display').classList.toggle('hidden', view !== 'piano');
            stopTest();
        }

        function toggleCoach() {
            coachMode = !coachMode;
            const btn = document.getElementById('coach-toggle');
            btn.innerText = coachMode ? "ON" : "OFF";
            btn.classList.toggle('active', coachMode);
        }

        function initPiano() {
            const bed = document.getElementById('piano-display');
            for(let i=0; i<13; i++) {
                const k = document.createElement('div');
                k.className = [1,3,6,8,10].includes(i%12) ? 'key black' : 'key';
                k.id = `key-${i}`;
                bed.appendChild(k);
            }
        }

        function startTest() {
            if(isPlaying) stopTest();
            const keys = Object.keys(MODES);
            currentModalName = keys[Math.floor(Math.random() * keys.length)];
            currentSequence = MODES[currentModalName];
            setupButtons();
            isPlaying = true;
            runLoop();
        }

        function runLoop() {
            let step = 0;
            playInterval = setInterval(() => {
                // Audio
                const freq = 440 * Math.pow(2, ((60 + currentSequence[step]) - 69) / 12);
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                osc.connect(g); g.connect(audioCtx.destination);
                g.gain.setValueAtTime(0.1, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
                osc.frequency.value = freq;
                osc.start(); osc.stop(audioCtx.currentTime + 0.5);

                // Visuals - ONLY if Coach Mode is ON
                clearVisuals();
                if(coachMode) {
                    if(currentView === 'screen') {
                        document.querySelectorAll('.pulse-light')[step].classList.add('active');
                    } else {
                        document.getElementById(`key-${currentSequence[step]}`).classList.add('active');
                    }
                }

                step = (step + 1) % 7;
            }, 600);
        }

        function setupButtons() {
            const container = document.getElementById('choices-container');
            container.innerHTML = '';
            const count = parseInt(document.getElementById('choiceCount').value);
            let options = [currentModalName];
            while(options.length < count) {
                let r = Object.keys(MODES)[Math.floor(Math.random() * 7)];
                if(!options.includes(r)) options.push(r);
            }
            options.sort().forEach(name => {
                const b = document.createElement('button');
                b.className = 'choice-btn';
                b.innerText = name;
                b.onclick = () => {
                    if(name === currentModalName) { 
                        b.classList.add('success'); stopTest(); 
                    } else { b.classList.add('fail'); }
                };
                container.appendChild(b);
            });
        }

        function stopTest() {
            isPlaying = false;
            clearInterval(playInterval);
            clearVisuals();
        }

        function clearVisuals() {
            document.querySelectorAll('.pulse-light').forEach(l => l.classList.remove('active'));
            document.querySelectorAll('.key').forEach(k => k.classList.remove('active'));
        }

        window.onload = initPiano;
    </script>
</body>
</html>