<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PRACTICE_DRILLS // Neural_Ninja_Mobile</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #030508; --blue: #4facfe; --gold: #ffcc00; 
            --green: #00ff88; --border: #1e2544; --red: #ff4b2b;
        }
        body { 
            margin: 0; background: var(--bg); color: #fff; font-family: 'Orbitron', sans-serif; 
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
            background-image: radial-gradient(circle at center, #0b1426 0%, #030508 100%);
            touch-action: none; -webkit-user-select: none; user-select: none;
        }

        /* HUD */
        .hud-top {
            display: flex; justify-content: space-between; align-items: center; padding: 10px 15px;
            font-size: 0.6rem; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.8);
            z-index: 100;
        }
        .metronome-flash { width: 12px; height: 12px; border-radius: 50%; background: var(--blue); opacity: 0; transition: opacity 0.05s; }

        .main-stage { flex-grow: 1; display: flex; flex-direction: column; align-items: center; position: relative; padding: 5px; }

        /* Mobile Control Bar */
        .controls-row { 
            display: flex; gap: 5px; width: 100%; overflow-x: auto; padding: 5px 0;
            scrollbar-width: none; z-index: 50;
        }
        .controls-row::-webkit-scrollbar { display: none; }
        
        .config-box { 
            flex: 0 0 90px; background: rgba(255,255,255,0.05); padding: 5px; 
            border: 1px solid var(--border); border-radius: 4px; text-align: center;
        }
        .config-box label { font-size: 0.4rem; color: var(--blue); font-weight: 900; display: block; margin-bottom: 2px; }
        
        select, button.ui-btn { 
            background: #000; color: #fff; border: 1px solid var(--border); 
            font-size: 0.5rem; width: 100%; height: 25px; font-family: 'Orbitron';
        }
        button.ui-btn.active { color: var(--green); border-color: var(--green); }

        /* Game Board */
        .lane-container { 
            display: flex; gap: 10px; flex-grow: 1; width: 100%; max-width: 600px;
            position: relative; margin: 10px 0;
        }
        
        .lane { 
            flex: 1; height: 100%; background: rgba(255,255,255,0.02); 
            border: 1px solid var(--border); position: relative; overflow: hidden;
            border-radius: 12px;
        }

        /* Responsive Hit Zone */
        .hit-zone {
            position: absolute; bottom: 0; width: 100%; height: 140px; 
            background: rgba(79, 172, 254, 0.05); border-top: 2px solid rgba(79, 172, 254, 0.3);
            display: flex; align-items: center; justify-content: center; 
            font-size: 2rem; font-weight: 900; color: rgba(79, 172, 254, 0.3);
            pointer-events: auto; z-index: 10;
        }
        
        /* The Target Line - Match this visually */
        .hit-zone::after {
            content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 3px;
            background: var(--blue); box-shadow: 0 0 15px var(--blue); transform: translateY(-50%);
        }

        .hit-zone.active { background: var(--blue); color: #000; }

        .note {
            position: absolute; width: 90%; left: 5%; height: 20px; background: var(--gold);
            box-shadow: 0 0 15px var(--gold); border-radius: 4px; z-index: 5;
        }

        .feedback {
            position: absolute; top: 30%; width: 100%; text-align: center;
            font-size: 0.8rem; font-weight: 900; z-index: 20; pointer-events: none;
            animation: feedUp 0.4s ease-out forwards;
        }
        @keyframes feedUp { 0% { opacity: 1; transform: scale(1.5); } 100% { opacity: 0; transform: translateY(-50px); } }

        .btn-start {
            width: 100%; height: 70px; background: var(--blue); border: none; 
            font-family: 'Orbitron'; font-weight: 900; font-size: 1.2rem; color: #000;
            clip-path: polygon(0 20%, 5% 0, 95% 0, 100% 20%, 100% 80%, 95% 100%, 5% 100%, 0 80%);
            margin-bottom: 20px;
        }
        .btn-start.running { background: var(--red); color: #fff; }
    </style>
</head>
<body>

    <div class="hud-top">
        <div id="xp-display" style="color:var(--gold)">XP: 0000</div>
        <div id="m-flash" class="metronome-flash"></div>
        <div id="acc-display">ACCURACY: 100%</div>
    </div>

    <div class="main-stage">
        <div class="controls-row">
            <div class="config-box"><label>PATTERN</label>
                <select id="patternType" onchange="resetPattern()">
                    <option value="random">RANDOM</option>
                    <option value="single_stroke_roll">SINGLE</option>
                    <option value="double_stroke_roll">DOUBLE</option>
                    <option value="single_paradiddle">PARA</option>
                </select>
            </div>
            <div class="config-box"><label>BPM: <span id="bpmVal">100</span></label>
                <input type="range" id="bpmSlider" min="40" max="220" value="100" oninput="updateBPM()" style="width:100%">
            </div>
            <div class="config-box"><label>SNARE</label>
                <button onclick="toggleAudio()" id="audio-btn" class="ui-btn">OFF</button>
            </div>
            <div class="config-box"><label>FEEDBACK</label>
                <button onclick="toggleTest()" id="test-btn" class="ui-btn">OFF</button>
            </div>
        </div>

        <div class="lane-container" id="lane-wrapper"></div>

        <button class="btn-start" id="start-btn" onclick="toggleGame()">START_PROTOCOL</button>
    </div>

    <script>
        let isPlaying = false, audioEnabled = false, testMode = false, audioCtx, gameLoop;
        let notes = [], masterInterval, patternStep = 0, lastTime = 0;
        let hits = 0, totalHits = 0;

        const RUDIMENTS = {
            single_stroke_roll: ['L','R'],
            double_stroke_roll: ['L','L','R','R'],
            single_paradiddle: ['L','R','L','L','R','L','R','R']
        };

        function initLanes() {
            const wrapper = document.getElementById('lane-wrapper');
            wrapper.innerHTML = '';
            ['D', 'J'].forEach((key, i) => {
                const lane = document.createElement('div'); lane.className = 'lane';
                const zone = document.createElement('div'); zone.className = 'hit-zone';
                zone.id = `zone-${i}`; zone.innerText = key;
                
                // Mobile-First Touch
                zone.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    triggerHit(i);
                });
                
                lane.appendChild(zone);
                wrapper.appendChild(lane);
            });
        }
        initLanes();

        function toggleAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            audioEnabled = !audioEnabled;
            document.getElementById('audio-btn').classList.toggle('active', audioEnabled);
            document.getElementById('audio-btn').innerText = audioEnabled ? "ON" : "OFF";
        }

        function toggleTest() {
            testMode = !testMode;
            document.getElementById('test-btn').classList.toggle('active', testMode);
            document.getElementById('test-btn').innerText = testMode ? "ON" : "OFF";
        }

        function updateBPM() {
            document.getElementById('bpmVal').innerText = document.getElementById('bpmSlider').value;
            if (isPlaying) { clearInterval(masterInterval); startMasterClock(); }
        }

        function startMasterClock() {
            const msPerBeat = 60000 / document.getElementById('bpmSlider').value;
            masterInterval = setInterval(() => {
                spawnNoteSync();
                const flash = document.getElementById('m-flash');
                flash.style.opacity = 1; setTimeout(() => flash.style.opacity = 0, 50);
            }, msPerBeat);
        }

        function spawnNoteSync() {
            const type = document.getElementById('patternType').value;
            let laneIdx = Math.floor(Math.random() * 2);
            if (type !== 'random') {
                const pat = RUDIMENTS[type];
                laneIdx = pat[patternStep % pat.length] === 'L' ? 0 : 1;
                patternStep++;
            }
            const noteEl = document.createElement('div'); noteEl.className = 'note';
            noteEl.style.top = '-20px';
            document.querySelectorAll('.lane')[laneIdx].appendChild(noteEl);
            notes.push({ el: noteEl, key: laneIdx, top: -20 });
        }

        function triggerHit(key) {
            if (!isPlaying) return;
            if (window.navigator.vibrate) window.navigator.vibrate(20); // Haptic

            const zone = document.getElementById(`zone-${key}`);
            const laneHeight = document.getElementById('lane-wrapper').offsetHeight;
            const targetCenter = laneHeight - 70; // Middle of hit zone line
            
            zone.classList.add('active');
            setTimeout(() => zone.classList.remove('active'), 80);

            if (audioEnabled && audioCtx) {
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                osc.connect(g); g.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            }

            // Accuracy check: (n.top + half-note-height) vs target line
            const hitIdx = notes.findIndex(n => n.key === key && Math.abs((n.top + 10) - targetCenter) < 70);
            
            if (testMode) {
                totalHits++;
                if (hitIdx !== -1) {
                    hits++;
                    const dist = Math.abs((notes[hitIdx].top + 10) - targetCenter);
                    showFeedback(key, dist < 20 ? "PERFECT" : "GOOD", dist < 20 ? "var(--green)" : "var(--gold)");
                } else {
                    showFeedback(key, "MISS", "var(--red)");
                }
                document.getElementById('acc-display').innerText = `ACCURACY: ${Math.floor((hits/totalHits)*100)}%`;
            }

            if (hitIdx !== -1) {
                notes[hitIdx].el.remove();
                notes.splice(hitIdx, 1);
            }
        }

        function showFeedback(key, text, color) {
            const zone = document.getElementById(`zone-${key}`);
            const fb = document.createElement('div');
            fb.className = 'feedback'; fb.style.color = color; fb.innerText = text;
            zone.appendChild(fb); setTimeout(() => fb.remove(), 400);
        }

        function updateNotes(dt) {
            const wrapper = document.getElementById('lane-wrapper');
            const laneHeight = wrapper.offsetHeight;
            const targetCenter = laneHeight - 70;
            const bpm = document.getElementById('bpmSlider').value;
            
            // Speed = Distance to target / Time per beat
            const speed = (targetCenter / (60000 / bpm)) * dt;
            
            for (let i = notes.length - 1; i >= 0; i--) {
                const n = notes[i];
                n.top += speed;
                n.el.style.top = n.top + 'px';
                
                if (n.top > laneHeight) {
                    if (testMode) { totalHits++; showFeedback(n.key, "MISS", "var(--red)"); }
                    n.el.remove();
                    notes.splice(i, 1);
                }
            }
        }

        function gameTick(t) {
            if(!isPlaying) return;
            const dt = t - (lastTime || t);
            lastTime = t;
            updateNotes(dt);
            gameLoop = requestAnimationFrame(gameTick);
        }

        function toggleGame() {
            isPlaying = !isPlaying; lastTime = 0;
            const btn = document.getElementById('start-btn');
            btn.innerText = isPlaying ? "TERMINATE_DRILL" : "START_PROTOCOL";
            btn.classList.toggle('running', isPlaying);
            
            if (isPlaying) {
                if (audioCtx) audioCtx.resume();
                notes.forEach(n => n.el.remove()); notes = [];
                hits = 0; totalHits = 0; patternStep = 0;
                startMasterClock(); gameTick(performance.now());
            } else {
                clearInterval(masterInterval); cancelAnimationFrame(gameLoop);
            }
        }

        function resetPattern() { patternStep = 0; }
        
        // Keyboard support for desktop testing
        document.addEventListener('keydown', e => {
            if (e.key.toLowerCase() === 'd') triggerHit(0);
            if (e.key.toLowerCase() === 'j') triggerHit(1);
        });
    </script>
</body>
</html>
