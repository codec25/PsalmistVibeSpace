<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Rankings | Ninja Music Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #05070a; --panel: #0b101a; --blue: #4facfe;
            --gold: #ffcc00; --border: #1e2544; --green: #00ff88; --red: #ff4444;
        }

        body {
            margin: 0; background: var(--bg); color: #fff;
            font-family: 'Orbitron', sans-serif; display: flex;
            flex-direction: column; align-items: center; min-height: 100vh;
            padding: 20px;
        }

        /* Top Global Stats Stats */
        .global-stats {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;
            width: 100%; max-width: 900px; margin-bottom: 30px;
        }
        .stat-card {
            background: var(--panel); border: 1px solid var(--border);
            padding: 15px; border-radius: 12px; text-align: center;
        }
        .stat-val { color: var(--gold); font-size: 1.2rem; font-weight: 900; }
        .stat-label { font-size: 0.5rem; color: #555; letter-spacing: 2px; margin-top: 5px; }

        /* Table Styling */
        .board-wrap {
            width: 100%; max-width: 900px; background: var(--panel);
            border: 1px solid var(--border); border-radius: 15px; overflow: hidden;
        }
        table { width: 100%; border-collapse: collapse; }
        th { 
            background: rgba(0,0,0,0.3); padding: 20px; text-align: left; 
            font-size: 0.6rem; color: var(--blue); letter-spacing: 2px;
            border-bottom: 1px solid var(--border);
        }
        td { padding: 20px; border-bottom: 1px solid #0f172a; font-size: 0.8rem; vertical-align: middle; }

        /* Rank & XP Bars */
        .player-info { display: flex; flex-direction: column; gap: 5px; }
        .name-tag { font-weight: 900; letter-spacing: 1px; }
        .bar-bg { width: 120px; height: 4px; background: #111; border-radius: 2px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--blue); box-shadow: 0 0 10px var(--blue); }

        .belt-badge {
            display: inline-block; padding: 4px 12px; border-radius: 20px;
            font-size: 0.55rem; font-weight: 900; border: 1px solid currentColor;
            background: rgba(255,255,255,0.02);
        }

        .row-me { background: rgba(79, 172, 254, 0.05); border-left: 4px solid var(--blue); }
        .row-me td { color: var(--gold); }

        .last-act { font-size: 0.6rem; color: #444; font-family: monospace; }

        .footer-nav { margin-top: 40px; text-decoration: none; color: #333; font-size: 0.7rem; }
        .footer-nav:hover { color: var(--blue); }
    </style>
</head>
<body>

    <div class="global-stats">
        <div class="stat-card"><div class="stat-val" id="totalNinjas">0</div><div class="stat-label">NINJAS ONLINE</div></div>
        <div class="stat-card"><div class="stat-val" id="totalGlobalXP">0</div><div class="stat-label">TOTAL SECTOR XP</div></div>
        <div class="stat-card"><div class="stat-val" id="topGrade">G1</div><div class="stat-label">PEAK GRADE</div></div>
    </div>

    <div class="board-wrap">
        <table>
            <thead>
                <tr>
                    <th># RANK</th>
                    <th>NINJA IDENTIFIER</th>
                    <th>LEVEL PROGRESSION</th>
                    <th style="text-align:right;">DATA LOGS</th>
                </tr>
            </thead>
            <tbody id="leaderboardBody">
                </tbody>
        </table>
    </div>

    <a href="index.html" class="footer-nav">‚Üê TERMINAL HUB</a>

    <script>
        const db = JSON.parse(localStorage.getItem('psalmistDB')) || { users: {} };
        const currentUser = localStorage.getItem('activeUser');

        function getRank(xp) {
            const grades = [
                { g: 1, n: "White Belt", c: "#fff", x: 500 },
                { g: 2, n: "Yellow Belt", c: "#ffff00", x: 1000 },
                { g: 3, n: "Orange Belt", c: "#ffaa00", x: 1500 },
                { g: 4, n: "Green Belt", c: "#00ff88", x: 2000 },
                { g: 5, n: "Blue Belt", c: "#4facfe", x: 2500 },
                { g: 6, n: "Purple Belt", c: "#a020f0", x: 3000 },
                { g: 7, n: "Red Belt", c: "#ff4444", x: 3500 },
                { g: 8, n: "Brown Belt", c: "#a52a2a", x: 4000 },
                { g: 9, n: "Elite Brown", c: "#8b4513", x: 4500 },
                { g: 10, n: "Master Red", c: "#cc0000", x: 5000 },
                { g: 11, n: "Grandmaster", c: "#ffd700", x: 6000 },
                { g: 12, n: "Black Belt", c: "#ffd700", x: 10000 }
            ];
            return grades.reverse().find(g => xp >= (grades.find(gr => gr.g === g.g-1)?.x || 0)) || grades[grades.length-1];
        }

        function initLeaderboard() {
            const players = Object.keys(db.users).map(name => ({
                name,
                xp: db.users[name].xp || 0,
                history: db.users[name].history || []
            })).sort((a, b) => b.xp - a.xp);

            // Update Top Stats
            document.getElementById('totalNinjas').innerText = players.length;
            document.getElementById('totalGlobalXP').innerText = players.reduce((sum, p) => sum + p.xp, 0).toLocaleString();
            document.getElementById('topGrade').innerText = "G" + getRank(players[0]?.xp || 0).g;

            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = players.map((p, i) => {
                const rank = getRank(p.xp);
                const nextXP = rank.x;
                const progress = Math.min((p.xp / nextXP) * 100, 100);
                const isMe = p.name === currentUser;
                const lastEntry = p.history.length > 0 ? p.history[p.history.length - 1].activity : "Initial Entry";

                return `
                    <tr class="${isMe ? 'row-me' : ''}">
                        <td>#${i + 1}</td>
                        <td>
                            <div class="player-info">
                                <span class="name-tag">${p.name.toUpperCase()}</span>
                                <span class="belt-badge" style="color:${rank.c}">${rank.n}</span>
                            </div>
                        </td>
                        <td>
                            <div class="player-info">
                                <span style="font-size:0.6rem; color:#444;">GRADE ${rank.g} PROGRESS</span>
                                <div class="bar-bg"><div class="bar-fill" style="width:${progress}%"></div></div>
                            </div>
                        </td>
                        <td style="text-align:right;">
                            <div class="player-info" style="align-items:flex-end;">
                                <span style="font-weight:900;">${p.xp.toLocaleString()} XP</span>
                                <span class="last-act">${lastEntry}</span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        initLeaderboard();
    </script>
</body>
</html>