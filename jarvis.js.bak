(() => {
  const OWNER_NAME = "Moise T. Sahouo";
  const MANIFEST_PATH = "./manifest.webmanifest";
  const SW_PATH = "./sw.js";
  const CHAT_STORAGE_KEY = "chatbot_lang";
  const VOICE_STORAGE_KEY = "chatbot_voice_on";

  const I18N = {
    en: {
      title: "Ninja Chat",
      placeholder: "Type a message...",
      send: "Send",
      voiceOn: "Voice ON",
      voiceOff: "Voice OFF",
      hello: "Hello. I can guide you through this app.",
      help: "Try: where am I, xp, return, help.",
      unknown: "I can help with navigation, XP, and quick page guidance.",
      page: "You are on",
      canReturn: "Use Return to go to",
      xp: "Your XP is",
      noXp: "I could not find XP yet.",
      returning: "Returning to",
      returnLabel: "RETURN",
      owner: OWNER_NAME
    },
    fr: {
      title: "Ninja Chat",
      placeholder: "Ecris un message...",
      send: "Envoyer",
      voiceOn: "Voix ON",
      voiceOff: "Voix OFF",
      hello: "Bonjour. Je peux te guider dans cette application.",
      help: "Essaye: ou suis-je, xp, retour, aide.",
      unknown: "Je peux aider avec navigation, XP et guidance rapide.",
      page: "Tu es sur",
      canReturn: "Utilise Retour pour aller a",
      xp: "Ton XP est",
      noXp: "Je ne trouve pas encore le XP.",
      returning: "Retour vers",
      returnLabel: "RETOUR",
      owner: OWNER_NAME
    }
  };

  const RETURN_MAP = {
    "admin.html": { href: "index.html", label: "Login" },
    "battle_engine.html": { href: "pitch_hub.html", label: "Pitch Hub" },
    "beat_machine.html": { href: "rhythm_hub.html", label: "Rhythm Hub" },
    "dashboard.html": { href: "hub.html", label: "Hub" },
    "hub.html": { href: "index.html", label: "Login" },
    "index.html": { href: "ninja_portal.html", label: "Portal" },
    "it_manager.html": { href: "index.html", label: "Login" },
    "it_recovery.html": { href: "index.html", label: "Login" },
    "it_vault.html": { href: "it_manager.html", label: "IT Manager" },
    "mini_studio.html": { href: "hub.html", label: "Hub" },
    "ninja_portal.html": { href: "index.html", label: "Login" },
    "pitch_hub.html": { href: "hub.html", label: "Hub" },
    "pitch_recognition.html": { href: "pitch_hub.html", label: "Pitch Hub" },
    "pitch_vocal.html": { href: "pitch_hub.html", label: "Pitch Hub" },
    "rhythm_hub.html": { href: "hub.html", label: "Hub" },
    "rhythm_ident.html": { href: "rhythm_hub.html", label: "Rhythm Hub" },
    "rhythm_practice.html": { href: "rhythm_hub.html", label: "Rhythm Hub" },
    "rhythm_strike.html": { href: "rhythm_hub.html", label: "Rhythm Hub" },
    "scroll_archive.html": { href: "sensei_dash.html", label: "Sensei Dash" },
    "studio.html": { href: "rhythm_hub.html", label: "Rhythm Hub" },
    "system_manual.html": { href: "it_manager.html", label: "IT Manager" },
    "system_status.html": { href: "it_manager.html", label: "IT Manager" }
  };

  let messagesEl;
  let inputEl;
  let voiceBtn;
  let sendBtn;
  let placeholderSet = false;

  function getPageFile() {
    return (location.pathname.split("/").pop() || "index.html").toLowerCase();
  }

  function getPageName() {
    return getPageFile().replace(".html", "").replace(/[_-]+/g, " ").trim() || "page";
  }

  function getLang() {
    const saved = localStorage.getItem(CHAT_STORAGE_KEY);
    if (saved === "en" || saved === "fr") return saved;
    return "en";
  }

  function setLang(lang) {
    localStorage.setItem(CHAT_STORAGE_KEY, lang);
  }

  function voiceEnabled() {
    return localStorage.getItem(VOICE_STORAGE_KEY) !== "false";
  }

  function setVoiceEnabled(v) {
    localStorage.setItem(VOICE_STORAGE_KEY, v ? "true" : "false");
  }

  function resolveReturnTarget() {
    const file = getPageFile();
    if (RETURN_MAP[file]) return RETURN_MAP[file];

    if (file.startsWith("pitch_")) return { href: "pitch_hub.html", label: "Pitch Hub" };
    if (file.startsWith("rhythm_")) return { href: "rhythm_hub.html", label: "Rhythm Hub" };
    if (file.startsWith("guitar_")) return { href: "hub.html", label: "Hub" };
    if (file.startsWith("it_")) return { href: "it_manager.html", label: "IT Manager" };

    if (["theory_vault.html", "interval_relations.html", "modal_logic.html"].includes(file)) {
      return { href: "pitch_hub.html", label: "Pitch Hub" };
    }

    return { href: "hub.html", label: "Hub" };
  }

  function safeSpeak(message, lang) {
    if (!("speechSynthesis" in window) || !voiceEnabled()) return;
    try {
      const text = String(message || "").trim();
      if (!text) return;

      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = lang === "fr" ? "fr-FR" : "en-US";
      utter.rate = 0.98;
      utter.pitch = 1.0;
      utter.volume = 0.9;

      const pickVoice = () => {
        const voices = window.speechSynthesis.getVoices() || [];
        const preferred = voices.find((v) =>
          (lang === "fr" ? v.lang.startsWith("fr") : v.lang.startsWith("en"))
        );
        if (preferred) utter.voice = preferred;
        window.speechSynthesis.speak(utter);
      };

      if ((window.speechSynthesis.getVoices() || []).length === 0) {
        window.speechSynthesis.onvoiceschanged = pickVoice;
      } else {
        pickVoice();
      }
    } catch (_err) {}
  }

  function appendMessage(role, text) {
    if (!messagesEl) return;
    const line = document.createElement("div");
    line.style.margin = "6px 0";
    line.style.fontSize = "12px";
    line.style.lineHeight = "1.35";
    line.style.color = role === "bot" ? "#dce9ff" : "#89ffcc";
    line.textContent = `${role === "bot" ? "Bot" : "You"}: ${text}`;
    messagesEl.appendChild(line);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function getXPValue() {
    const raw = localStorage.getItem("totalXP");
    const n = Number(raw);
    if (Number.isFinite(n) && n >= 0) return Math.floor(n);
    return null;
  }

  function botReplyFor(message, lang) {
    const t = I18N[lang];
    const m = String(message || "").toLowerCase().trim();
    const target = resolveReturnTarget();

    if (!m) return t.help;

    if (/(help|aide|commands|commandes)/.test(m)) {
      return t.help;
    }

    if (/(where|ou|suis-je|where am i|ou suis je|page)/.test(m)) {
      return `${t.page} ${getPageName()}. ${t.canReturn} ${target.label}.`;
    }

    if (/(xp|score|points?)/.test(m)) {
      const xp = getXPValue();
      return xp === null ? t.noXp : `${t.xp} ${xp}.`;
    }

    if (/(return|retour|back|go back)/.test(m)) {
      setTimeout(() => {
        location.href = target.href;
      }, 350);
      return `${t.returning} ${target.label}...`;
    }

    if (/(hello|hi|bonjour|salut)/.test(m)) {
      return `${t.hello} ${t.help}`;
    }

    return `${t.unknown} ${t.help}`;
  }

  function sendMessage() {
    const lang = getLang();
    const text = inputEl ? inputEl.value.trim() : "";
    if (!text) return;
    appendMessage("you", text);
    if (inputEl) inputEl.value = "";

    const reply = botReplyFor(text, lang);
    appendMessage("bot", reply);
    safeSpeak(reply, lang);
  }

  function ensurePWAHead() {
    if (!document.head) return;

    const upsertMeta = (attr, value, content) => {
      let node = document.head.querySelector(`meta[${attr}="${value}"]`);
      if (!node) {
        node = document.createElement("meta");
        node.setAttribute(attr, value);
        document.head.appendChild(node);
      }
      node.setAttribute("content", content);
    };

    let manifest = document.head.querySelector('link[rel="manifest"]');
    if (!manifest) {
      manifest = document.createElement("link");
      manifest.rel = "manifest";
      manifest.href = MANIFEST_PATH;
      document.head.appendChild(manifest);
    }

    if (!document.head.querySelector('link[rel="icon"][href*="pitch-icon.svg"]')) {
      const icon = document.createElement("link");
      icon.rel = "icon";
      icon.type = "image/svg+xml";
      icon.href = "icons/pitch-icon.svg";
      document.head.appendChild(icon);
    }

    upsertMeta("name", "theme-color", "#020406");
    upsertMeta("name", "apple-mobile-web-app-capable", "yes");
    upsertMeta("name", "apple-mobile-web-app-status-bar-style", "black-translucent");
    upsertMeta("name", "apple-mobile-web-app-title", "Ninja Music Academy");
  }

  function ensureOwnerFooter() {
    if (!document.body || !document.head) return;

    if (!document.getElementById("codex-owner-style")) {
      const style = document.createElement("style");
      style.id = "codex-owner-style";
      style.textContent = `
        #codex-owner-footer {
          position: fixed;
          left: 50%;
          bottom: 8px;
          transform: translateX(-50%);
          z-index: 9996;
          padding: 6px 10px;
          border-radius: 999px;
          border: 1px solid rgba(79, 172, 254, 0.35);
          background: rgba(2, 4, 6, 0.8);
          color: #9fceff;
          font-size: 10px;
          letter-spacing: 0.08em;
          pointer-events: none;
          font-family: "Orbitron", system-ui, -apple-system, "Segoe UI", sans-serif;
          backdrop-filter: blur(4px);
        }
      `;
      document.head.appendChild(style);
    }

    const existing = document.querySelector(".maker-footer, .owner-footer, #codex-owner-footer");
    if (existing) {
      existing.id = "codex-owner-footer";
      existing.textContent = OWNER_NAME;
      return;
    }

    const footer = document.createElement("footer");
    footer.id = "codex-owner-footer";
    footer.textContent = OWNER_NAME;
    document.body.appendChild(footer);
  }

  function ensureReturnButton() {
    if (!document.body || !document.head) return;
    const lang = getLang();
    const t = I18N[lang];
    const target = resolveReturnTarget();

    if (!document.getElementById("codex-return-style")) {
      const style = document.createElement("style");
      style.id = "codex-return-style";
      style.textContent = `
        #codex-return-btn {
          position: fixed;
          left: 12px;
          top: 12px;
          z-index: 9997;
          border: 1px solid rgba(255,255,255,0.25);
          background: rgba(2, 4, 6, 0.85);
          color: #ffffff;
          padding: 8px 11px;
          border-radius: 10px;
          font-size: 11px;
          letter-spacing: 0.04em;
          text-decoration: none;
          font-family: "Orbitron", system-ui, -apple-system, "Segoe UI", sans-serif;
          box-shadow: 0 8px 18px rgba(0,0,0,0.35);
        }
      `;
      document.head.appendChild(style);
    }

    let btn = document.getElementById("codex-return-btn");
    if (!btn) {
      btn = document.createElement("a");
      btn.id = "codex-return-btn";
      document.body.appendChild(btn);
    }

    btn.setAttribute("href", target.href);
    btn.textContent = `${t.returnLabel}: ${target.label}`;
  }

  function ensureServiceWorker() {
    if (!("serviceWorker" in navigator)) return;
    window.addEventListener("load", () => {
      navigator.serviceWorker.register(SW_PATH).catch(() => {});
    });
  }

  function buildChatbot() {
    if (!document.body) return;

    const lang = getLang();
    const t = I18N[lang];

    const root = document.createElement("div");
    root.id = "codex-chatbot";
    root.style.position = "fixed";
    root.style.right = "14px";
    root.style.bottom = "44px";
    root.style.width = "290px";
    root.style.maxWidth = "calc(100vw - 28px)";
    root.style.border = "1px solid rgba(125,175,255,0.45)";
    root.style.background = "rgba(13,20,33,0.9)";
    root.style.borderRadius = "12px";
    root.style.color = "#e9f2ff";
    root.style.boxShadow = "0 10px 24px rgba(0,0,0,0.35)";
    root.style.backdropFilter = "blur(6px)";
    root.style.padding = "8px";
    root.style.zIndex = "9999";
    root.style.fontFamily = "system-ui, -apple-system, Segoe UI, Roboto, sans-serif";

    const titleRow = document.createElement("div");
    titleRow.style.display = "flex";
    titleRow.style.justifyContent = "space-between";
    titleRow.style.alignItems = "center";
    titleRow.style.marginBottom = "6px";

    const title = document.createElement("div");
    title.textContent = t.title;
    title.style.fontSize = "12px";
    title.style.fontWeight = "700";
    title.style.letterSpacing = "0.08em";
    title.style.color = "#98c0ff";

    const langBox = document.createElement("div");
    langBox.style.display = "flex";
    langBox.style.gap = "4px";

    const enBtn = document.createElement("button");
    enBtn.type = "button";
    enBtn.textContent = "EN";
    enBtn.style.fontSize = "10px";
    enBtn.style.cursor = "pointer";
    enBtn.style.border = "1px solid #5f86c7";
    enBtn.style.background = lang === "en" ? "#2b4d80" : "#20314d";
    enBtn.style.color = "#dce9ff";
    enBtn.style.borderRadius = "6px";
    enBtn.style.padding = "4px 6px";
    enBtn.onclick = () => {
      setLang("en");
      location.reload();
    };

    const frBtn = document.createElement("button");
    frBtn.type = "button";
    frBtn.textContent = "FR";
    frBtn.style.fontSize = "10px";
    frBtn.style.cursor = "pointer";
    frBtn.style.border = "1px solid #5f86c7";
    frBtn.style.background = lang === "fr" ? "#2b4d80" : "#20314d";
    frBtn.style.color = "#dce9ff";
    frBtn.style.borderRadius = "6px";
    frBtn.style.padding = "4px 6px";
    frBtn.onclick = () => {
      setLang("fr");
      location.reload();
    };

    langBox.appendChild(enBtn);
    langBox.appendChild(frBtn);
    titleRow.appendChild(title);
    titleRow.appendChild(langBox);

    messagesEl = document.createElement("div");
    messagesEl.style.height = "122px";
    messagesEl.style.overflowY = "auto";
    messagesEl.style.border = "1px solid rgba(255,255,255,0.1)";
    messagesEl.style.borderRadius = "8px";
    messagesEl.style.padding = "7px";
    messagesEl.style.background = "rgba(0,0,0,0.22)";
    messagesEl.style.marginBottom = "7px";

    const controls = document.createElement("div");
    controls.style.display = "flex";
    controls.style.gap = "5px";

    inputEl = document.createElement("input");
    inputEl.type = "text";
    inputEl.placeholder = t.placeholder;
    inputEl.style.flex = "1";
    inputEl.style.border = "1px solid #5f86c7";
    inputEl.style.background = "#13263e";
    inputEl.style.color = "#e6f0ff";
    inputEl.style.borderRadius = "7px";
    inputEl.style.padding = "7px";
    inputEl.style.fontSize = "12px";
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    sendBtn = document.createElement("button");
    sendBtn.type = "button";
    sendBtn.textContent = t.send;
    sendBtn.style.border = "1px solid #5f86c7";
    sendBtn.style.background = "#20314d";
    sendBtn.style.color = "#dce9ff";
    sendBtn.style.borderRadius = "7px";
    sendBtn.style.padding = "7px 9px";
    sendBtn.style.fontSize = "12px";
    sendBtn.style.cursor = "pointer";
    sendBtn.onclick = sendMessage;

    controls.appendChild(inputEl);
    controls.appendChild(sendBtn);

    voiceBtn = document.createElement("button");
    voiceBtn.type = "button";
    voiceBtn.textContent = voiceEnabled() ? t.voiceOn : t.voiceOff;
    voiceBtn.style.marginTop = "6px";
    voiceBtn.style.width = "100%";
    voiceBtn.style.border = "1px solid #5f86c7";
    voiceBtn.style.background = "#20314d";
    voiceBtn.style.color = "#dce9ff";
    voiceBtn.style.borderRadius = "7px";
    voiceBtn.style.padding = "6px";
    voiceBtn.style.fontSize = "11px";
    voiceBtn.style.cursor = "pointer";
    voiceBtn.onclick = () => {
      const next = !voiceEnabled();
      setVoiceEnabled(next);
      voiceBtn.textContent = next ? t.voiceOn : t.voiceOff;
    };

    root.appendChild(titleRow);
    root.appendChild(messagesEl);
    root.appendChild(controls);
    root.appendChild(voiceBtn);
    document.body.appendChild(root);

    const target = resolveReturnTarget();
    const hello = `${t.hello} ${t.page} ${getPageName()}. ${t.canReturn} ${target.label}.`;
    appendMessage("bot", hello);
    safeSpeak(hello, lang);
  }

  function bootstrapGlobalAppFeatures() {
    ensurePWAHead();
    ensureOwnerFooter();
    ensureReturnButton();
    ensureServiceWorker();
    buildChatbot();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", bootstrapGlobalAppFeatures);
  } else {
    bootstrapGlobalAppFeatures();
  }
})();
