<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grand Station Titan | Full Build</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #030508; --panel: #0a0e17; --blue: #4facfe; 
            --gold: #ffcc00; --border: #1e2544; --red: #ff4b2b; --green: #00ff88;
        }
        body { 
            margin: 0; background: var(--bg); color: #fff; font-family: 'Orbitron', sans-serif; 
            overflow: hidden; display: flex; flex-direction: column; height: 100vh; touch-action: none;
        }

        /* --- Header & Monitor --- */
        header { padding: 10px 20px; background: #000; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .monitor { background: #000; padding: 5px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; color: var(--green); font-size: 0.7rem; }
        
        /* --- Controls --- */
        .action-bar { background: var(--panel); padding: 10px 20px; display: flex; gap: 8px; border-bottom: 1px solid var(--border); align-items: center; overflow-x: auto; }
        .btn-ui { background: #1a1f2c; border: 1px solid var(--border); color: #fff; padding: 8px 12px; font-size: 0.55rem; cursor: pointer; border-radius: 4px; white-space: nowrap; font-family: 'Orbitron'; transition: 0.2s; }
        .btn-ui.active { border-color: var(--blue); color: var(--blue); background: rgba(79, 172, 254, 0.1); }
        .btn-wait.active { border-color: var(--red); color: var(--red); box-shadow: 0 0 10px var(--red); }
        .btn-teach.recording { background: var(--gold); color: #000; animation: blink 1s infinite; }

        /* --- Viewport (Staff + Piano Roll) --- */
        #viewport { flex-grow: 1; position: relative; background: #000; overflow: hidden; }
        #piano-roll { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #staff-canvas { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.95); border-radius: 8px; border: 2px solid var(--blue); pointer-events: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* --- Keyboard --- */
        .keyboard-wrapper { width: 100%; overflow-x: auto; background: #111; padding: 25px 0; border-top: 2px solid var(--blue); z-index: 100; scrollbar-width: none; }
        .piano { display: flex; width: fit-content; padding: 0 50px; position: relative; }
        .key { border: 1px solid #000; border-radius: 0 0 5px 5px; cursor: pointer; flex-shrink: 0; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 10px; user-select: none; transition: transform 0.05s, background 0.1s; }
        .white { width: 50px; height: 180px; background: #fff; color: #888; }
        .black { width: 32px; height: 110px; background: #222; color: #fff; margin-left: -16px; margin-right: -16px; z-index: 2; font-size: 0.5rem; }
        
        .key.active { background: var(--blue) !important; color: #000; transform: translateY(4px); }
        .key.target { box-shadow: inset 0 -40px 20px var(--gold); border-bottom: 8px solid var(--gold); }
        .key.wrong { background: var(--red) !important; }
        .key span { display: none; font-size: 0.6rem; font-weight: 900; pointer-events: none; }
        body.show-labels .key span { display: block; }

        @keyframes blink { 50% { opacity: 0.4; } }
    </style>
</head>
<body>

    <header>
        <div style="font-weight: 900;">GRAND_STATION <span style="color:var(--blue)">TITAN_PRO</span></div>
        <div id="status" style="color: var(--gold); font-size: 0.6rem;">SYSTEM_ONLINE</div>
    </header>

    <div class="monitor">
        <div id="chord-name">CHORD: ---</div>
        <div id="lesson-score">STEP: 0/0</div>
        <div id="bpm-display">BPM: 120</div>
    </div>

    <div class="action-bar">
        <button class="btn-ui" onclick="toggleLabels()">SHOW_LABELS</button>
        <button class="btn-ui btn-wait" id="waitBtn" onclick="toggleWaitMode()">WAIT_MODE</button>
        <button class="btn-ui" id="susBtn" onclick="toggleSustain()">SUSTAIN</button>
        <div style="display:flex; align-items:center; gap:5px; background:#1a1f2c; padding:0 10px; border-radius:4px;">
            <button class="btn-ui" onclick="toggleMetronome()" id="metroBtn" style="border:none">METRO</button>
            <input type="range" id="tempoSlider" min="40" max="220" value="120" oninput="updateTempo()">
        </div>
        <button class="btn-ui btn-teach" id="teachBtn" onclick="toggleTeacherRec()">TEACHER_REC</button>
        <button class="btn-ui" onclick="startLesson()" style="color:var(--green)">START_EXERCISE</button>
        <button class="btn-ui" onclick="window.print()" style="margin-left:auto">EXPORT_SCORE</button>
    </div>

    <div id="viewport">
        <canvas id="piano-roll"></canvas>
        <canvas id="staff-canvas" width="650" height="320"></canvas>
    </div>

    <div class="keyboard-wrapper">
        <div class="piano" id="piano"></div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const staffCanvas = document.getElementById('staff-canvas');
        const sCtx = staffCanvas.getContext('2d');
        const rollCanvas = document.getElementById('piano-roll');
        const rCtx = rollCanvas.getContext('2d');

        let isSustain = false, isMetroOn = false, isWaitMode = false, isTeacherRecording = false;
        let activeNotes = new Map(); // Store oscillators for note-off
        let activeMidiSet = new Set();
        let teacherSequence = [], fallingNotes = [], lessonStartTime = 0;
        let tempo = 120, metroInterval, currentStep = 0;

        // --- Improved Sound Engine with Note-Off ---
        function noteOn(midi) {
            if (activeNotes.has(midi)) return;
            const now = audioCtx.currentTime;
            const freq = 440 * Math.pow(2, (midi - 69) / 12);
            
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(freq, now);
            
            g.gain.setValueAtTime(0, now);
            g.gain.linearRampToValueAtTime(0.2, now + 0.02);
            
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start();
            
            activeNotes.set(midi, { osc, g });
            activeMidiSet.add(midi);
            updateNotation();
            updateChord();

            if (isTeacherRecording) teacherSequence.push({ midi, time: Date.now() - lessonStartTime });
            
            const k = document.querySelector(`[data-midi="${midi}"]`);
            if (k) {
                k.classList.add('active');
                if (isWaitMode && teacherSequence.length > 0) {
                    if (midi === teacherSequence[currentStep]?.midi) {
                        currentStep++;
                        updateScore();
                        k.classList.remove('target');
                    } else {
                        k.classList.add('wrong');
                        setTimeout(() => k.classList.remove('wrong'), 400);
                    }
                }
            }
        }

        function noteOff(midi) {
            const note = activeNotes.get(midi);
            if (!note) return;
            
            const now = audioCtx.currentTime;
            const rel = isSustain ? 2.5 : 0.3;
            note.g.gain.cancelScheduledValues(now);
            note.g.gain.setValueAtTime(note.g.gain.value, now);
            note.g.gain.exponentialRampToValueAtTime(0.001, now + rel);
            note.osc.stop(now + rel);
            
            activeNotes.delete(midi);
            activeMidiSet.delete(midi);
            updateNotation();
            
            const k = document.querySelector(`[data-midi="${midi}"]`);
            if (k) k.classList.remove('active');
        }

        // --- Graphics Engine ---
        function updateNotation() {
            sCtx.clearRect(0,0,650,320); sCtx.strokeStyle="#333"; sCtx.font="45px Georgia";
            sCtx.fillText("ùÑû", 30, 90); sCtx.fillText("ùÑ¢", 30, 200);
            for(let i=0; i<5; i++){
                sCtx.beginPath(); sCtx.moveTo(20, 60+i*14); sCtx.lineTo(630, 60+i*14); sCtx.stroke();
                sCtx.beginPath(); sCtx.moveTo(20, 160+i*14); sCtx.lineTo(630, 160+i*14); sCtx.stroke();
            }
            activeMidiSet.forEach(midi => {
                const whiteMap = [0,0,1,1,2,3,3,4,4,5,5,6];
                const totalSteps = (Math.floor(midi/12)-5)*7 + whiteMap[midi%12];
                const y = 130 - (totalSteps * 7);
                sCtx.fillStyle="#000"; sCtx.beginPath(); sCtx.ellipse(325, y, 9, 6, Math.PI/-4, 0, Math.PI*2); sCtx.fill();
                // Ledger Lines
                if(y <= 46 || y >= 130) {
                    let startY = y <= 46 ? 46 : 130;
                    let endY = y;
                    if(startY > endY) [startY, endY] = [endY, startY];
                    for(let ly = startY; ly <= endY; ly += 14) {
                        sCtx.beginPath(); sCtx.moveTo(310, ly); sCtx.lineTo(340, ly); sCtx.stroke();
                    }
                }
            });
        }

        function animateRoll() {
            rCtx.clearRect(0,0,rollCanvas.width,rollCanvas.height);
            const speed = (tempo / 60) * 3;
            const keyWidth = rollCanvas.width / 88;
            
            fallingNotes.forEach((note, i) => {
                note.y += speed;
                rCtx.fillStyle = `hsl(${(note.midi % 12) * 30}, 80%, 60%)`;
                rCtx.shadowBlur = 10; rCtx.shadowColor = rCtx.fillStyle;
                const x = (note.midi - 21) * keyWidth;
                rCtx.fillRect(x, note.y, keyWidth - 2, 30);
                rCtx.shadowBlur = 0;
                
                if (note.y > rollCanvas.height - 60) {
                    const k = document.querySelector(`[data-midi="${note.midi}"]`);
                    if(k) k.classList.add('target');
                    if(!isWaitMode) fallingNotes.splice(i, 1);
                }
            });
            requestAnimationFrame(animateRoll);
        }

        // --- System Controls ---
        function toggleTeacherRec() {
            isTeacherRecording = !isTeacherRecording;
            const btn = document.getElementById('teachBtn');
            if (isTeacherRecording) {
                teacherSequence = []; lessonStartTime = Date.now();
                btn.classList.add('recording'); btn.innerText = "FINISH";
                document.getElementById('status').innerText = "RECORDING LESSON...";
            } else { 
                btn.classList.remove('recording'); btn.innerText = "TEACHER_REC";
                document.getElementById('status').innerText = "LESSON SAVED";
            }
        }

        function startLesson() {
            if(!teacherSequence.length) return;
            currentStep = 0;
            fallingNotes = teacherSequence.map(n => ({ midi: n.midi, y: -n.time / 5 }));
            updateScore();
            document.querySelectorAll('.key').forEach(k => k.classList.remove('target'));
        }

        function toggleWaitMode() { isWaitMode = !isWaitMode; document.getElementById('waitBtn').classList.toggle('active'); }
        function toggleSustain() { isSustain = !isSustain; document.getElementById('susBtn').classList.toggle('active'); }
        function updateTempo() { tempo = document.getElementById('tempoSlider').value; document.getElementById('bpm-display').innerText = `BPM: ${tempo}`; }
        function updateScore() { document.getElementById('lesson-score').innerText = `STEP: ${currentStep}/${teacherSequence.length}`; }
        function toggleLabels() { document.body.classList.toggle('show-labels'); }
        
        function toggleMetronome() {
            isMetroOn = !isMetroOn; document.getElementById('metroBtn').classList.toggle('active');
            if(isMetroOn) metroInterval = setInterval(() => {
                const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                o.frequency.value = 1200; g.gain.value = 0.05;
                o.connect(g); g.connect(audioCtx.destination);
                o.start(); o.stop(audioCtx.currentTime+0.05);
            }, (60/tempo)*1000);
            else clearInterval(metroInterval);
        }

        function updateChord() {
            const sorted = Array.from(activeMidiSet).sort((a,b)=>a-b);
            if(sorted.length < 3) { document.getElementById('chord-name').innerText = "CHORD: ---"; return; }
            const root = sorted[0];
            const signature = sorted.map(n => (n-root)%12).filter((v,i,a)=>a.indexOf(v)===i).sort((a,b)=>a-b).join(',');
            const CHORD_MAP = {"0,4,7":"Major", "0,3,7":"Minor", "0,4,7,10":"7th", "0,4,7,11":"Maj7", "0,3,7,10":"Min7"};
            const rootName = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'][root%12];
            document.getElementById('chord-name').innerText = `CHORD: ${rootName} ${CHORD_MAP[signature] || '...'}`;
        }

        // --- Initialization ---
        window.addEventListener('resize', () => { rollCanvas.width = window.innerWidth; rollCanvas.height = window.innerHeight - 300; });
        rollCanvas.width = window.innerWidth; rollCanvas.height = window.innerHeight - 300;
        
        const piano = document.getElementById('piano');
        for(let m=21; m<=108; m++) {
            const k = document.createElement('div');
            k.className = `key ${[1,3,6,8,10].includes(m%12) ? 'black' : 'white'}`;
            k.dataset.midi = m;
            k.innerHTML = `<span>${['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'][m%12]}${Math.floor(m/12)-1}</span>`;
            
            k.onmousedown = k.ontouchstart = (e) => { e.preventDefault(); noteOn(m); };
            k.onmouseup = k.ontouchend = k.onmouseleave = () => noteOff(m);
            piano.appendChild(k);
        }

        if(navigator.requestMIDIAccess) {
            navigator.requestMIDIAccess().then(access => {
                for(let input of access.inputs.values()) input.onmidimessage = (msg) => {
                    const [status, note, vel] = msg.data;
                    if(status === 144 && vel > 0) noteOn(note);
                    else if(status === 128 || (status === 144 && vel === 0)) noteOff(note);
                };
            });
        }
        
        updateNotation();
        animateRoll();
        document.querySelector('[data-midi="60"]').scrollIntoView({inline:'center'});
    </script>
</body>
</html>
