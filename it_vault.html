<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IT_VAULT // Neural Repository</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon: #00ff41; --bg: #050505; --panel: rgba(10,15,10,0.9);
            --syntax-kw: #ff007f; --syntax-str: #ffcc00;
        }
        body, html { margin: 0; padding: 0; background: var(--bg); color: var(--neon); font-family: 'Fira Code', monospace; height: 100vh; overflow: hidden; }
        #matrix-canvas { position: fixed; top: 0; left: 0; z-index: 0; opacity: 0.2; }

        /* --- AUTH SCREEN --- */
        #login-gate {
            position: fixed; inset: 0; z-index: 9999; display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(20px);
        }
        .login-box { width: 350px; padding: 40px; border: 1px solid var(--neon); background: #000; text-align: center; box-shadow: 0 0 20px var(--neon); }
        .login-input { width: 100%; background: #111; border: 1px solid #333; color: var(--neon); padding: 12px; margin-bottom: 15px; font-family: 'Fira Code'; outline: none; box-sizing: border-box; }
        .btn-access { width: 100%; padding: 12px; background: var(--neon); color: #000; border: none; font-family: 'Orbitron'; font-weight: 900; cursor: pointer; }
        
        #decrypt-loader { display: none; margin-top: 20px; font-size: 0.8rem; letter-spacing: 2px; }

        /* --- MAIN INTERFACE --- */
        #vault-interface { display: none; position: relative; z-index: 10; height: 100vh; flex-direction: column; }
        header { padding: 15px 25px; background: rgba(0,0,0,0.8); border-bottom: 1px solid var(--neon); display: flex; justify-content: space-between; align-items: center; }
        .main-layout { display: grid; grid-template-columns: 280px 1fr 320px; gap: 20px; padding: 20px; flex-grow: 1; overflow: hidden; }
        .panel { background: var(--panel); border: 1px solid var(--neon); padding: 15px; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Editor */
        .editor-container { position: relative; flex-grow: 1; background: #000; border: 1px solid #222; }
        #code-input, #code-highlight { position: absolute; inset: 0; padding: 15px; font-size: 0.9rem; line-height: 1.5; font-family: 'Fira Code'; white-space: pre-wrap; box-sizing: border-box; }
        #code-input { z-index: 2; background: transparent; color: transparent; caret-color: white; border: none; outline: none; resize: none; }
        #code-highlight { z-index: 1; color: #444; pointer-events: none; }
        .token-keyword { color: var(--syntax-kw); } .token-string { color: var(--syntax-str); }

        .btn-ui { background: transparent; border: 1px solid var(--neon); color: var(--neon); padding: 8px 12px; cursor: pointer; font-family: 'Orbitron'; font-size: 0.65rem; }
        #log-feed { flex-grow: 1; overflow-y: auto; font-size: 0.7rem; color: rgba(0,255,65,0.7); background: #000; padding: 10px; border: 1px solid #111; }
    </style>
</head>
<body>

<canvas id="matrix-canvas"></canvas>

<div id="login-gate">
    <div class="login-box">
        <h2 style="font-family:'Orbitron';">VAULT_AUTH_v6</h2>
        <p style="font-size: 0.6rem; color: #444; margin-bottom: 20px;">SENSEI CREDENTIALS REQUIRED</p>
        <input type="text" id="user-id" class="login-input" placeholder="SENSEI_ID">
        <input type="password" id="user-pass" class="login-input" placeholder="SECURITY_KEY">
        <button id="auth-btn" class="btn-access" onclick="handleAuth()">AUTHORIZE</button>
        <div id="decrypt-loader">DECRYPTING: <span id="percent">0%</span></div>
        <p id="error-msg" style="color:red; display:none; font-size:0.7rem; margin-top:10px;"></p>
        <p id="recovery-trigger" style="display:none; color:var(--syntax-str); cursor:pointer; font-size:0.5rem; margin-top:10px; text-decoration:underline;" onclick="sendRecoveryHint()">[ SIGNAL_RECOVERY_HINT_TO_DASH ]</p>
    </div>
</div>

<div id="vault-interface">
    <header>
        <div style="font-family:'Orbitron';">SENSEI: <span id="display-user" style="color:white;">---</span></div>
        <div id="timer-display" style="color:red; font-size:0.8rem;">SESSION: 05:00</div>
        <button class="btn-ui" onclick="window.location.href='sensei_dash.html'">CLOSE_VAULT</button>
    </header>

    <div class="main-layout">
        <div class="panel">
            <div style="font-size:0.7rem; margin-bottom:10px; letter-spacing: 2px;">NEURAL_STORAGE</div>
            <div id="snippet-list" style="flex-grow:1; overflow-y:auto;"></div>
            <button class="btn-ui" onclick="clearAll()">PURGE_DRIVE</button>
        </div>

        <div class="panel">
            <div class="editor-container">
                <textarea id="code-input" spellcheck="false" oninput="resetTimer(); updateEditor();" placeholder="// Enter code or secret scrolls here..."></textarea>
                <pre id="code-highlight"><code></code></pre>
            </div>
            <div style="margin-top:15px; display:flex; gap:10px;">
                <input type="text" id="filename" placeholder="SCROLL_NAME.txt" style="background:#000; border:1px solid #333; color:white; padding:10px; flex-grow:1; font-family: 'Fira Code';">
                <button class="btn-ui" style="border-color: #00d4ff; color: #00d4ff;" onclick="broadcastToLink()">NEURAL_LINK</button>
                <button class="btn-ui" style="border-color: var(--syntax-str); color: var(--syntax-str);" onclick="saveSnippet()">COMMIT_TO_VAULT</button>
            </div>
        </div>

        <div class="panel">
            <div style="font-size:0.7rem; margin-bottom:10px; letter-spacing: 2px;">VAULT_LOG <span id="ghost-status" style="color:red; display:none;">[GHOST_ACTIVE]</span></div>
            <div id="log-feed"></div>
            <input type="text" id="term-cmd" placeholder="root@vault:~#" style="width:100%; background:#000; border:1px solid var(--neon); color:white; padding:8px; font-size:0.7rem; margin-top:10px;" onkeydown="if(event.key==='Enter') runTerminal(this.value)">
        </div>
    </div>
</div>

<script>
    let activeUser = "";
    let ghostMode = false;

    // --- 1. AUDIT & DASHBOARD UPLINK ---
    function reportToIT(status) {
        let db = JSON.parse(localStorage.getItem('vault_users')) || { AUDIT_LOG: [] };
        const entry = { 
            time: new Date().toLocaleTimeString(), 
            user: activeUser || "UNKNOWN_SENSEI", 
            status: `VAULT: ${status}` 
        };
        db.AUDIT_LOG.unshift(entry);
        localStorage.setItem('vault_users', JSON.stringify(db));

        localStorage.setItem('system_broadcast', JSON.stringify({ 
            message: `SECURITY_ALERT: ${activeUser || 'UNKNOWN'} -> ${status}`, 
            type: 'VAULT_NOTIFY', 
            timestamp: Date.now() 
        }));
    }

    // --- 2. AUTHENTICATION & HINT PROTOCOL ---
    async function handleAuth() {
        const u = document.getElementById('user-id').value.trim().toUpperCase();
        const p = document.getElementById('user-pass').value.trim();
        const loader = document.getElementById('decrypt-loader');
        const btn = document.getElementById('auth-btn');
        const err = document.getElementById('error-msg');
        const rec = document.getElementById('recovery-trigger');

        const db = JSON.parse(localStorage.getItem('vault_users')) || {};
        const teachers = db.teachers || {};

        btn.style.display = 'none';
        loader.style.display = 'block';
        err.style.display = 'none';
        rec.style.display = 'none';
        
        let pct = 0;
        let iv = setInterval(() => { 
            pct += Math.floor(Math.random()*20); 
            if(pct > 100) pct = 100; 
            document.getElementById('percent').innerText = pct + "%"; 
        }, 100);

        await new Promise(r => setTimeout(r, 1200)); 
        clearInterval(iv);

        if(teachers[u] && teachers[u] === p) {
            activeUser = u;
            document.getElementById('login-gate').style.display = 'none';
            document.getElementById('vault-interface').style.display = 'flex';
            document.getElementById('display-user').innerText = u;
            startTimer();
            logSystem(`[SECURE_CONNECTION_ESTABLISHED]`);
            reportToIT("ACCESS_GRANTED");
            loadList();
            startLockdownListener();
            startRemotePurgeListener();
        } else {
            loader.style.display = 'none';
            btn.style.display = 'block';
            err.innerText = "INVALID_ENCRYPTION_KEY";
            err.style.display = 'block';
            rec.style.display = 'block';
            reportToIT(`LOGIN_FAILED: ${u}`);
        }
    }

    function sendRecoveryHint() {
        const u = document.getElementById('user-id').value.trim().toUpperCase();
        if(!u) return alert("ENTER_SENSEI_ID_FIRST");
        
        localStorage.setItem('system_broadcast', JSON.stringify({ 
            message: `RECOVERY_PROTOCOL: SENSEI [${u}] REQUESTED A KEY_HINT.`, 
            type: 'RECOVERY', 
            timestamp: Date.now() 
        }));
        alert("SIGNAL_TRANSMITTED_TO_DASH_FEED.");
    }

    // --- 3. SESSION & LOCKDOWN PROTOCOLS ---
    let sessionTime = 300;
    function startTimer() {
        setInterval(() => {
            sessionTime--;
            let m = Math.floor(sessionTime/60), s = sessionTime%60;
            document.getElementById('timer-display').innerText = `SESSION: ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            if(sessionTime <= 0) {
                reportToIT("SESSION_EXPIRED");
                location.reload();
            }
        }, 1000);
    }
    function resetTimer() { sessionTime = 300; }

    function startLockdownListener() {
        setInterval(() => {
            if(localStorage.getItem('it_active') === 'true') {
                reportToIT("SURVEILLANCE_INTERCEPT_LOCKDOWN");
                alert("WARNING: SYSTEM SURVEILLANCE DETECTED. EMERGENCY LOGOUT INITIATED.");
                location.reload();
            }
        }, 2000);
    }

    function startRemotePurgeListener() {
        window.addEventListener('storage', (e) => {
            if(e.key === 'remote_vault_purge' && e.newValue === 'true') {
                localStorage.removeItem('vault_snippets');
                localStorage.setItem('remote_vault_purge', 'false');
                reportToIT("REMOTE_EMERGENCY_PURGE_EXECUTED");
                alert("DANGER: REMOTE PURGE SIGNAL RECEIVED. WIPING DATA.");
                location.reload();
            }
        });
    }

    // --- 4. TERMINAL & GHOST PROTOCOLS ---
    function runTerminal(val) {
        document.getElementById('term-cmd').value = '';
        logSystem(`> ${val}`);
        if(val === 'help') logSystem("CMDS: help, clear, status, reveal --ghost, hide, purge, broadcast");
        else if(val === 'clear') document.getElementById('log-feed').innerHTML = '';
        else if(val === 'status') logSystem("KERNEL: OPTIMAL\nINTEGRITY: 100%\nGHOST_PROTO: READY\nNEURAL_LINK: ACTIVE");
        else if(val === 'reveal --ghost') {
            ghostMode = true;
            document.getElementById('ghost-status').style.display = 'inline';
            loadList();
            logSystem("DEEP_STORAGE_REVEALED");
            reportToIT("GHOST_ACCESS_INITIATED");
        }
        else if(val === 'hide') {
            ghostMode = false;
            document.getElementById('ghost-status').style.display = 'none';
            loadList();
            logSystem("GHOST_FILES_ENCRYPTED");
        }
        else if(val === 'purge') clearAll();
        else if(val === 'broadcast') broadcastToLink();
        else logSystem(`ERR: COMMAND_${val.toUpperCase()}_NOT_FOUND`);
    }

    // --- 5. EDITOR, STORAGE & NEURAL LINK ---
    function updateEditor() {
        let code = document.getElementById('code-input').value;
        code = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        code = code.replace(/\b(const|let|var|function|return|if|else)\b/g, '<span class="token-keyword">$1</span>');
        code = code.replace(/(".*?"|'.*?'|`.*?`)/g, '<span class="token-string">$1</span>');
        document.querySelector('#code-highlight code').innerHTML = code + (code.endsWith('\n') ? ' ' : '');
    }

    function saveSnippet() {
        const name = document.getElementById('filename').value || "unnamed_scroll.txt";
        const code = document.getElementById('code-input').value;
        if(!code) return;

        const snips = JSON.parse(localStorage.getItem('vault_snippets')) || [];
        snips.push({ name, code, author: activeUser, date: new Date().toLocaleDateString() });
        localStorage.setItem('vault_snippets', JSON.stringify(snips));
        
        loadList();
        logSystem(`Committed: ${name}`);
        reportToIT(`SAVED_SCROLL: ${name}`);
        document.getElementById('filename').value = "";
        document.getElementById('code-input').value = "";
        updateEditor();
    }

    function broadcastToLink() {
        const code = document.getElementById('code-input').value;
        const name = document.getElementById('filename').value || "ANONYMOUS_SCROLL";
        if(!code) return alert("CANNOT_BROADCAST_EMPTY_SCROLL");

        let feed = JSON.parse(localStorage.getItem('student_announcements')) || [];
        feed.unshift({
            title: `NEURAL_LINK: ${name}`,
            content: code,
            sender: activeUser,
            time: new Date().toLocaleTimeString(),
            type: 'CODE_DROP'
        });
        localStorage.setItem('student_announcements', JSON.stringify(feed));
        
        logSystem(`Neural Link: Broadcasted ${name}`);
        reportToIT(`BROADCAST_SCROLL: ${name}`);
    }

    function loadList() {
        const list = document.getElementById('snippet-list');
        list.innerHTML = '';
        const snips = JSON.parse(localStorage.getItem('vault_snippets')) || [];
        snips.reverse().forEach((s, i) => {
            const isGhost = s.name.startsWith("GHOST_");
            if(isGhost && !ghostMode) return;

            const d = document.createElement('div');
            const borderCol = isGhost ? "var(--syntax-kw)" : "var(--neon)";
            const bgCol = isGhost ? "rgba(255,0,127,0.1)" : "rgba(0,255,0,0.05)";
            
            d.style = `padding:10px; border-left:2px solid ${borderCol}; background:${bgCol}; margin-bottom:8px; cursor:pointer; font-size:0.6rem;`;
            d.innerHTML = `<div style="color:white;">${s.name}</div><div style="color:#444; font-size:0.5rem;">BY: ${s.author} | ${s.date}</div>`;
            d.onclick = () => { 
                document.getElementById('code-input').value = s.code; 
                document.getElementById('filename').value = s.name;
                updateEditor(); 
                logSystem(`Loaded: ${s.name}`);
            };
            list.appendChild(d);
        });
    }

    function logSystem(m) {
        const f = document.getElementById('log-feed');
        f.innerHTML += `<div style="white-space:pre-wrap; margin-bottom:5px;">[${new Date().toLocaleTimeString()}] ${m}</div>`;
        f.scrollTop = f.scrollHeight;
    }

    function clearAll() { 
        if(confirm("DANGER: WIPE ALL NEURAL SCROLLS?")) { 
            localStorage.removeItem('vault_snippets'); 
            loadList(); 
            reportToIT("STORAGE_PURGED");
            logSystem("STORAGE_DRIVE_WIPED");
        } 
    }

    // --- 6. MATRIX FX ---
    const canvas = document.getElementById('matrix-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    const drops = Array(Math.floor(canvas.width/16)).fill(1);
    function draw() {
        ctx.fillStyle = 'rgba(0,0,0,0.05)'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#0F0'; ctx.font = '16px monospace';
        drops.forEach((y, i) => {
            ctx.fillText(Math.floor(Math.random()*2), i*16, y*16);
            if(y*16 > canvas.height && Math.random() > 0.98) drops[i] = 0;
            drops[i]++;
        });
    }
    setInterval(draw, 40);
    window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
</script>
</body>
</html>
