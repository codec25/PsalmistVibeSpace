<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Theory Scrolls | Grand Master Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #05070a; --panel: #0b101a; --blue: #4facfe;
            --gold: #ffcc00; --green: #00ff88; --pink: #e94560; --border: #1e2544;
        }

        body {
            margin: 0; background: var(--bg); color: #fff;
            font-family: 'Orbitron', sans-serif; display: flex;
            flex-direction: column; align-items: center; min-height: 100vh;
            padding: 15px; box-sizing: border-box;
        }

        .header-ui { width: 100%; max-width: 1100px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); padding: 15px 0; margin-bottom: 20px; }
        
        .layout { display: grid; grid-template-columns: 1fr 380px; gap: 20px; width: 100%; max-width: 1100px; }

        .scroll-card { background: var(--panel); border: 1px solid var(--border); padding: 25px; border-radius: 15px; text-align: center; }
        
        /* Harmonic Mode Switcher */
        .mode-toggle { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .m-btn { background: #000; border: 1px solid var(--border); color: #555; padding: 8px 12px; border-radius: 20px; font-size: 0.5rem; cursor: pointer; transition: 0.3s; font-family: 'Orbitron'; }
        .m-btn.active { color: #fff; border-color: var(--blue); box-shadow: 0 0 10px rgba(79, 172, 254, 0.3); }
        .m-btn.active.dim { border-color: var(--pink); box-shadow: 0 0 10px rgba(233, 69, 96, 0.3); }

        .circle-container { width: 300px; height: 300px; margin: 20px auto; position: relative; border-radius: 50%; border: 1px solid rgba(79, 172, 254, 0.1); }
        .note-node { 
            position: absolute; width: 42px; height: 42px; background: #000; 
            border: 1px solid var(--blue); border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; font-size: 0.75rem; 
            transform: translate(-50%, -50%); cursor: pointer; transition: 0.2s; z-index: 5;
        }
        .note-node.coach-pulse { border-color: var(--green); box-shadow: 0 0 20px var(--green); background: rgba(0, 255, 136, 0.2); }
        
        .scroll-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px; text-align: left; }
        .scroll-box { background: rgba(79, 172, 254, 0.03); border: 1px solid var(--border); padding: 15px; border-radius: 10px; }
        .scroll-box h4 { margin: 0 0 5px 0; font-size: 0.65rem; color: var(--blue); letter-spacing: 1px; }
        .scroll-box p { font-size: 0.55rem; line-height: 1.4; color: #888; margin: 0; }

        .exam-panel { background: rgba(79, 172, 254, 0.05); border: 1px solid var(--blue); padding: 25px; border-radius: 15px; text-align: center; height: fit-content; }
        select { background: #000; color: var(--blue); border: 1px solid var(--blue); padding: 12px; width: 100%; margin-bottom: 15px; font-family: 'Orbitron'; font-size: 0.7rem; }
        .btn-action { width: 100%; padding: 15px; background: var(--blue); color: #000; border: none; font-family: 'Orbitron'; font-weight: 900; cursor: pointer; border-radius: 5px; text-transform: uppercase; }

        #quizBox { display: none; text-align: left; margin-top: 20px; }
        .q-text { font-size: 0.8rem; margin-bottom: 15px; line-height: 1.4; min-height: 45px; }
        .opt-btn { width: 100%; padding: 12px; margin: 8px 0; background: #000; border: 1px solid #222; color: #fff; cursor: pointer; font-family: 'Orbitron'; font-size: 0.7rem; text-align: left; transition: 0.2s; }
        .opt-btn.coach-hint { border-color: var(--green); border-left: 5px solid var(--green); background: rgba(0, 255, 136, 0.05); }

        .coach-bar { margin-top: 25px; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; padding: 10px; border-top: 1px solid #111; }
        .led { width: 8px; height: 8px; border-radius: 50%; background: #333; transition: 0.3s; }

        @media (max-width: 950px) { .layout { grid-template-columns: 1fr; } .scroll-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="header-ui">
        <div style="font-weight: 900; font-size: 0.9rem; letter-spacing: 2px;">THEORY SCROLLS</div>
        <div id="xpTag" style="color: var(--gold); font-size: 0.7rem;">GUEST // 0 XP</div>
    </div>

    <div class="layout">
        <div class="scroll-card">
            <div class="mode-toggle">
                <button class="m-btn active" id="btn-major" onclick="setHarmonicMode('major')">MAJOR</button>
                <button class="m-btn" id="btn-minor" onclick="setHarmonicMode('minor')">MINOR</button>
                <button class="m-btn" id="btn-dim" onclick="setHarmonicMode('dim')">DIMINISHED</button>
            </div>
            
            <div class="circle-container" id="wheel">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none;">
                    <div style="color: var(--gold); font-size: 0.7rem; font-weight: 900;">CIRCLE</div>
                    <div style="color: #444; font-size: 0.35rem; letter-spacing: 2px;">OF FIFTHS</div>
                </div>
            </div>

            <div class="scroll-grid">
                <div class="scroll-box">
                    <h4>SCROLL I: HARMONIC MODES</h4>
                    <p>Toggle modes to hear how the 3rd and 5th intervals shift. Major (Bright), Minor (Dark), Diminished (Tense).</p>
                </div>
                <div class="scroll-box">
                    <h4>SCROLL II: THE TRITONE</h4>
                    <p>Diminished mode uses the 'Diabolus in Musica'â€”the flattened 5th. Essential for jazz and horror scores.</p>
                </div>
            </div>
        </div>

        <div class="exam-panel">
            <div id="setup">
                <div style="font-size: 0.55rem; color: #555; margin-bottom: 15px; letter-spacing: 2px;">VALIDATE MASTERY</div>
                <select id="gradeSelect">
                    <option value="1">GRADE 1: BASIC INTERVALS</option>
                    <option value="5">GRADE 5: HARMONIC SCALES</option>
                    <option value="9">GRADE 9: MODAL ARCHITECTURE</option>
                    <option value="12">GRADE 12: MASTER COMPOSER</option>
                </select>
                <select id="lengthSelect">
                    <option value="5">5 QUESTIONS</option>
                    <option value="10">10 QUESTIONS</option>
                    <option value="20">20 QUESTIONS</option>
                </select>
                <button class="btn-action" onclick="startExam()">BEGIN EXAM</button>
            </div>

            <div id="quizBox">
                <div id="qCount" style="font-size: 0.5rem; color: var(--gold); margin-bottom: 10px;"></div>
                <div id="qText" class="q-text"></div>
                <div id="options"></div>
            </div>

            <div class="coach-bar" onclick="toggleCoach()">
                <div id="coachLed" class="led"></div>
                <span style="font-size: 0.5rem; color: var(--gold); letter-spacing: 1px;">COACH MODE: <span id="coachStatus">OFF</span></span>
            </div>
        </div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const freqMap = {"C": 261.63, "G": 392.00, "D": 293.66, "A": 440.00, "E": 329.63, "B": 493.88, "F#": 369.99, "Db": 277.18, "Ab": 415.30, "Eb": 311.13, "Bb": 466.16, "F": 349.23};
        const notes = ["C","G","D","A","E","B","F#","Db","Ab","Eb","Bb","F"];
        let currentHarmonicMode = 'major';
        let db = JSON.parse(localStorage.getItem('psalmistDB')) || { users: { "Guest": { xp: 0 } } };
        const user = localStorage.getItem('activeUser') || "Guest";

        function setHarmonicMode(mode) {
            currentHarmonicMode = mode;
            document.querySelectorAll('.m-btn').forEach(b => b.classList.remove('active', 'dim'));
            const activeBtn = document.getElementById(`btn-${mode}`);
            activeBtn.classList.add('active');
            if (mode === 'dim') activeBtn.classList.add('dim');
        }

        function playChord(note) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            
            if(localStorage.getItem('coachMode') === 'true') {
                const node = document.getElementById(`node-${note}`);
                node.classList.add('coach-pulse');
                setTimeout(() => node.classList.remove('coach-pulse'), 800);
            }

            // Harmonic Intervals: Major (1, 1.25, 1.5), Minor (1, 1.189, 1.5), Dim (1, 1.189, 1.414)
            let intervals = [1, 1.25, 1.5];
            if (currentHarmonicMode === 'minor') intervals = [1, 1.189, 1.5];
            if (currentHarmonicMode === 'dim') intervals = [1, 1.189, 1.414];

            intervals.forEach(interval => {
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(freqMap[note] * interval, now);
                g.gain.setValueAtTime(0.08, now);
                g.gain.exponentialRampToValueAtTime(0.001, now + 1.2);
                osc.connect(g); g.connect(audioCtx.destination);
                osc.start(); osc.stop(now + 1.2);
            });
        }

        // Build Circle UI
        notes.forEach((note, i) => {
            const angle = (i * 30 - 90) * (Math.PI / 180);
            const x = 150 + 115 * Math.cos(angle);
            const y = 150 + 115 * Math.sin(angle);
            const node = document.createElement('div');
            node.className = 'note-node';
            node.id = `node-${note}`;
            node.style.left = `${x}px`; node.style.top = `${y}px`;
            node.innerText = note;
            node.onclick = () => playChord(note);
            document.getElementById('wheel').appendChild(node);
        });

        // Expanded Curriculum Database
        const curriculum = {
            1: { qs: [{q:"How many sharps in C Major?", a:["0","1","4"], c:0}, {q:"What is a Perfect 5th above C?", a:["F","G","A"], c:1}, {q:"Interval from C to E?", a:["Major 2nd","Major 3rd"], c:1}] },
            5: { qs: [{q:"Relative Minor of C Major?", a:["D Minor","A Minor"], c:1}, {q:"Key with 2 sharps (F#, C#)?", a:["D Major","G Major"], c:0}] },
            9: { qs: [{q:"Which mode has a raised 4th?", a:["Lydian","Dorian"], c:0}, {q:"The 5th mode of Major is:", a:["Aeolian","Mixolydian"], c:1}] },
            12: { qs: [{q:"Tritone substitution for G7?", a:["Db7","F#7"], c:0}, {q:"Negative Harmony of G in C Major?", a:["C","F"], c:1}] }
        };

        let currentExam = [], qIdx = 0, score = 0;

        function toggleCoach() {
            const active = localStorage.getItem('coachMode') === 'true';
            localStorage.setItem('coachMode', !active);
            updateCoachUI();
            if(document.getElementById('quizBox').style.display === 'block') renderQ();
        }

        function updateCoachUI() {
            const active = localStorage.getItem('coachMode') === 'true';
            document.getElementById('coachLed').style.background = active ? 'var(--green)' : '#333';
            document.getElementById('coachLed').style.boxShadow = active ? '0 0 10px var(--green)' : 'none';
            document.getElementById('coachStatus').innerText = active ? 'ON' : 'OFF';
        }

        function startExam() {
            const grade = document.getElementById('gradeSelect').value;
            const len = parseInt(document.getElementById('lengthSelect').value);
            const pool = curriculum[grade].qs;
            currentExam = [];
            for(let i=0; i<len; i++) currentExam.push(pool[i % pool.length]);
            
            document.getElementById('setup').style.display = 'none';
            document.getElementById('quizBox').style.display = 'block';
            qIdx = 0; score = 0;
            renderQ();
        }

        function renderQ() {
            const q = currentExam[qIdx];
            const isCoach = localStorage.getItem('coachMode') === 'true';
            document.getElementById('qCount').innerText = `EXAM: QUESTION ${qIdx + 1}/${currentExam.length}`;
            document.getElementById('qText').innerText = q.q;
            
            const area = document.getElementById('options');
            area.innerHTML = "";
            q.a.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = `opt-btn ${isCoach && i === q.c ? 'coach-hint' : ''}`;
                btn.innerText = opt + (isCoach && i === q.c ? " [COACH HINT]" : "");
                btn.onclick = () => {
                    if(i === q.c) score++;
                    qIdx++;
                    if(qIdx < currentExam.length) renderQ(); else finishExam();
                };
                area.appendChild(btn);
            });
        }

        function finishExam() {
            const earnedXP = score * 20;
            alert(`EXAMINATION COMPLETE\nScore: ${score}/${currentExam.length}\nXP Gained: ${earnedXP}`);
            db.users[user].xp += earnedXP;
            localStorage.setItem('psalmistDB', JSON.stringify(db));
            location.reload();
        }

        updateCoachUI();
        document.getElementById('xpTag').innerText = `${user.toUpperCase()} // ${db.users[user].xp || 0} XP`;
    </script>
</body>
</html>