<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Kraken | Final Trial</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #05070a; --panel: #0b101a; --blue: #4facfe;
            --pink: #e94560; --gold: #ffcc00; --green: #00ff88;
        }

        body {
            margin: 0; background: var(--bg); color: #fff;
            font-family: 'Orbitron', sans-serif; display: flex;
            flex-direction: column; align-items: center; min-height: 100vh;
            overflow-x: hidden;
        }

        /* Kraken Visuals */
        .kraken-container {
            width: 100%; max-width: 800px; text-align: center;
            padding: 40px 20px; position: relative;
        }

        .tentacle-aura {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100vw; height: 100vh; background: radial-gradient(circle, rgba(233, 69, 96, 0.05) 0%, transparent 70%);
            pointer-events: none; z-index: -1;
        }

        .boss-hp-bar {
            width: 100%; height: 10px; background: #111; border: 1px solid var(--pink);
            margin: 20px 0; border-radius: 5px; overflow: hidden;
        }

        #bossFill { width: 100%; height: 100%; background: var(--pink); transition: 0.5s ease-out; }

        .game-state { font-size: 0.7rem; letter-spacing: 3px; color: var(--pink); margin-bottom: 10px; }

        .display-node {
            font-size: 4rem; font-weight: 900; color: #fff;
            text-shadow: 0 0 20px rgba(255,255,255,0.2); margin: 30px 0;
        }

        /* Interaction Grid */
        .action-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            margin-top: 30px;
        }

        .btn-action {
            padding: 20px; background: rgba(0,0,0,0.6); border: 1px solid var(--pink);
            color: #fff; font-family: 'Orbitron'; font-weight: 700; cursor: pointer;
            border-radius: 8px; transition: 0.2s;
        }

        .btn-action:hover { background: var(--pink); color: #000; box-shadow: 0 0 20px var(--pink); }

        .status-hud {
            display: flex; justify-content: space-between; width: 100%;
            margin-bottom: 20px; font-size: 0.8rem;
        }

        .lives { color: var(--pink); }
        .score { color: var(--gold); }

        .back-nav { margin-top: 50px; color: #444; font-size: 0.6rem; cursor: pointer; }
    </style>
</head>
<body>

    <div class="tentacle-aura"></div>

    <div class="kraken-container">
        <div class="status-hud">
            <div class="lives">LIVES: <span id="lifeCount">♥♥♥</span></div>
            <div class="score">XP BOUNTY: <span id="xpBounty">0</span></div>
        </div>

        <div class="game-state" id="modeLabel">INITIALIZING GAUNTLET...</div>
        <div class="boss-hp-bar"><div id="bossFill"></div></div>
        
        <div id="displayNode" class="display-node">?</div>

        <button id="startBtn" class="btn-action" style="width: 100%; background: var(--pink); color: #000;" onclick="startTrial()">BEGIN TRIAL</button>

        <div class="action-grid" id="actionGrid" style="display: none;">
            </div>

        <div class="back-nav" onclick="location.href='index.html'">← ABANDON TRIAL</div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const notes = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        const rhythms = ['4/4', '3/4', '6/8', '5/4', '7/8', '12/8'];
        
        let lives = 3;
        let bounty = 0;
        let currentTarget = null;
        let currentMode = 'pitch'; // pitch or rhythm
        let bossHealth = 100;

        function startTrial() {
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('actionGrid').style.display = 'grid';
            nextStage();
        }

        function playTone(freq) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 1);
        }

        function nextStage() {
            if (lives <= 0) return gameOver();
            
            // Randomly switch modes
            currentMode = Math.random() > 0.5 ? 'pitch' : 'rhythm';
            const grid = document.getElementById('actionGrid');
            const label = document.getElementById('modeLabel');
            const node = document.getElementById('displayNode');
            grid.innerHTML = '';
            node.innerText = "?";

            if (currentMode === 'pitch') {
                label.innerText = "PITCH IDENTIFICATION MODE";
                const note = notes[Math.floor(Math.random() * 12)];
                const oct = Math.floor(Math.random() * 3) + 3;
                currentTarget = note;
                
                // Play frequency
                const freq = 440 * Math.pow(2, (notes.indexOf(note) - 9 + (oct - 4) * 12) / 12);
                playTone(freq);

                // Create options
                let options = [note];
                while(options.length < 4) {
                    let rN = notes[Math.floor(Math.random() * 12)];
                    if(!options.includes(rN)) options.push(rN);
                }
                renderButtons(options.sort());

            } else {
                label.innerText = "TIME SIGNATURE RECOGNITION";
                const sig = rhythms[Math.floor(Math.random() * rhythms.length)];
                currentTarget = sig;
                
                // Simulated metronome click
                node.innerText = "⌛";
                playRhythmClue(sig);

                renderButtons([...rhythms].sort(() => Math.random() - 0.5).slice(0, 4));
            }
        }

        function playRhythmClue(sig) {
            // Simple double-beep for rhythm
            playTone(880);
            setTimeout(() => playTone(440), 250);
            setTimeout(() => playTone(440), 500);
        }

        function renderButtons(options) {
            const grid = document.getElementById('actionGrid');
            options.forEach(opt => {
                const b = document.createElement('button');
                b.className = 'btn-action';
                b.innerText = opt;
                b.onclick = () => checkAnswer(opt);
                grid.appendChild(b);
            });
        }

        function checkAnswer(ans) {
            if (ans === currentTarget) {
                bounty += 250;
                bossHealth -= 10;
                document.getElementById('bossFill').style.width = bossHealth + "%";
                document.getElementById('xpBounty').innerText = bounty;
                if (bossHealth <= 0) return victory();
                nextStage();
            } else {
                lives--;
                document.getElementById('lifeCount').innerText = "♥".repeat(lives);
                if (lives <= 0) gameOver();
            }
        }

        function victory() {
            updateXP(bounty + 1000); // Massive bonus
            alert("KRAKEN SLAIN! Bonus 1000 XP Awarded.");
            location.href = 'index.html';
        }

        function gameOver() {
            updateXP(bounty);
            alert("TRIAL FAILED. You escaped with " + bounty + " XP.");
            location.href = 'index.html';
        }

        function updateXP(amount) {
            const user = localStorage.getItem('activeUser');
            let db = JSON.parse(localStorage.getItem('psalmistDB'));
            if(user && db.users[user]) {
                db.users[user].xp += amount;
                localStorage.setItem('psalmistDB', JSON.stringify(db));
            }
        }
    </script>
</body>
</html>