<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dojo - Piano Mastery Arena</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&display=swap" rel="stylesheet">
    <style>
        :root { --glow: #4f8cff; --accent: #ffd700; --boss: #ff416c; --bg: #02030a; }
        body { margin:0; background: var(--bg); color:#fff; text-align:center; font-family:'Orbitron'; overflow-x: hidden; }
        
        .hud { background:rgba(255,255,255,0.1); padding:15px; border-bottom:2px solid var(--glow); display: flex; justify-content: space-between; align-items: center; }
        .btn-nav { background:#222; color: #fff; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-family: 'Orbitron'; }

        /* REALISTIC TWO-OCTAVE LAYOUT */
        .piano-container { 
            display: flex; justify-content: center; margin: 40px auto; padding: 25px; 
            background: #111; border-radius: 12px; width: fit-content; position: relative; 
            box-shadow: 0 25px 60px rgba(0,0,0,0.6); border: 4px solid #333;
        }
        
        .octave { position: relative; display: flex; }
        .key { cursor: pointer; user-select: none; transition: 0.1s; }
        
        .white { 
            width: 55px; height: 240px; background: linear-gradient(#fff 90%, #eee); 
            border: 1px solid #ccc; border-radius: 0 0 5px 5px; z-index: 1;
            display: flex; align-items: flex-end; justify-content: center;
            color: #333; font-weight: 900; padding-bottom: 15px; font-size: 1.1rem;
        }

        .black { 
            width: 34px; height: 145px; background: linear-gradient(#000, #333); 
            border: 1px solid #000; border-radius: 0 0 4px 4px;
            position: absolute; z-index: 2; transform: translateX(-50%);
            box-shadow: 2px 5px 10px rgba(0,0,0,0.5);
        }

        .key:active, .key.active { transform: translateY(3px); filter: brightness(1.3); }
        .white.active { background: var(--glow); color: white; border-color: var(--glow); }

        /* CONTROLS & CHORD DISPLAY */
        .controls { margin: 20px; display: flex; justify-content: center; gap: 20px; align-items: center; flex-wrap: wrap; }
        .btn-play { background: var(--accent); color: #000; padding: 15px 35px; font-weight: 900; border: none; border-radius: 8px; cursor: pointer; font-family: 'Orbitron'; }
        
        .mode-btn { background: #1a1f3c; color: #4f8cff; border: 1px solid #4f8cff; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-family: 'Orbitron'; font-size: 0.8rem; }
        .mode-btn.active { background: var(--glow); color: white; }
        
        #chordNameDisplay { font-size: 1.5rem; color: var(--glow); margin-top: 10px; height: 30px; font-weight: 900; text-shadow: 0 0 10px var(--glow); }
    </style>
</head>
<body>

<div class="hud">
    <button onclick="window.location.href='index.html'" class="btn-nav">â¬… HALL</button>
    <div>
        <span id="ninjaName" style="color:var(--glow)">NINJA</span> | 
        <span id="xpDisp" style="color:var(--accent)">0 XP</span>
    </div>
    <div id="targetDisplay" style="color: var(--accent); font-weight: 900; letter-spacing: 1px;">TARGET: C</div>
</div>

<div class="controls">
    <button class="btn-play" onclick="playTargetAudio()">ðŸ”Š HEAR TARGET</button>
    <div style="background: #111; padding: 10px; border-radius: 8px; border: 1px solid #333;">
        <button class="mode-btn" id="singleBtn" onclick="setPlayMode('single')">SINGLE ðŸŽµ</button>
        <button class="mode-btn active" id="majBtn" onclick="setPlayMode('major')">MAJOR ðŸ˜Š</button>
        <button class="mode-btn" id="minBtn" onclick="setPlayMode('minor')">MINOR ðŸ˜¢</button>
    </div>
</div>

<div id="chordNameDisplay"></div>

<div class="piano-container" id="piano">
    <div class="octave">
        <div class="key white" onclick="handleInput('C')">C</div>
        <div class="key black" style="left: 55px;" onclick="handleInput('C#')"></div>
        <div class="key white" onclick="handleInput('D')">D</div>
        <div class="key black" style="left: 110px;" onclick="handleInput('D#')"></div>
        <div class="key white" onclick="handleInput('E')">E</div>
        <div class="key white" onclick="handleInput('F')">F</div>
        <div class="key black" style="left: 220px;" onclick="handleInput('F#')"></div>
        <div class="key white" onclick="handleInput('G')">G</div>
        <div class="key black" style="left: 275px;" onclick="handleInput('G#')"></div>
        <div class="key white" onclick="handleInput('A')">A</div>
        <div class="key black" style="left: 330px;" onclick="handleInput('A#')"></div>
        <div class="key white" onclick="handleInput('B')">B</div>
    </div>
    <div class="octave">
        <div class="key white" onclick="handleInput('C2')">C</div>
        <div class="key black" style="left: 55px;" onclick="handleInput('C#2')"></div>
        <div class="key white" onclick="handleInput('D2')">D</div>
        <div class="key black" style="left: 110px;" onclick="handleInput('D#2')"></div>
        <div class="key white" onclick="handleInput('E2')">E</div>
        <div class="key white" onclick="handleInput('F2')">F</div>
        <div class="key black" style="left: 220px;" onclick="handleInput('F#2')"></div>
        <div class="key white" onclick="handleInput('G2')">G</div>
        <div class="key black" style="left: 275px;" onclick="handleInput('G#2')"></div>
        <div class="key white" onclick="handleInput('A2')">A</div>
        <div class="key black" style="left: 330px;" onclick="handleInput('A#2')"></div>
        <div class="key white" onclick="handleInput('B2')">B</div>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const NOTES = { 
        "C": 261.6, "C#": 277.2, "D": 293.7, "D#": 311.1, "E": 329.6, "F": 349.2, "F#": 370.0, "G": 392.0, "G#": 415.3, "A": 440.0, "A#": 466.2, "B": 493.9,
        "C2": 523.2, "C#2": 554.4, "D2": 587.3, "D#2": 622.2, "E2": 659.2, "F2": 698.5, "F#2": 740.0, "G2": 784.0, "G#2": 830.6, "A2": 880.0, "A#2": 932.3, "B2": 987.8
    };
    
    let db = JSON.parse(localStorage.getItem('psalmistDB')) || { users: {"Guest":0}, goal: 500 };
    let user = localStorage.getItem('activeUser') || "Guest";
    let targetNote = "C";
    let playMode = "major"; // Options: 'single', 'major', 'minor'

    function playTone(freq, timeOffset = 0) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'triangle';
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime + timeOffset);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + timeOffset + 1);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(audioCtx.currentTime + timeOffset); osc.stop(audioCtx.currentTime + timeOffset + 1.2);
    }

    function playFullChord(rootKey) {
        const noteKeys = Object.keys(NOTES);
        const rootIdx = noteKeys.indexOf(rootKey);
        const thirdInterval = (playMode === 'major') ? 4 : 3;
        
        playTone(NOTES[rootKey]);
        let thirdNote = "N/A", fifthNote = "N/A";
        
        if(noteKeys[rootIdx + thirdInterval]) {
            playTone(NOTES[noteKeys[rootIdx + thirdInterval]], 0.05);
            thirdNote = noteKeys[rootIdx + thirdInterval].replace(/[0-9]/g, '');
        }
        if(noteKeys[rootIdx + 7]) {
            playTone(NOTES[noteKeys[rootIdx + 7]], 0.1);
            fifthNote = noteKeys[rootIdx + 7].replace(/[0-9]/g, '');
        }

        const baseRoot = rootKey.replace(/[0-9]/g, '');
        document.getElementById('chordNameDisplay').innerText = 
            `${baseRoot} ${playMode.toUpperCase()}: ${baseRoot} - ${thirdNote} - ${fifthNote}`;
    }

    function playTargetAudio() {
        if (playMode === 'single') {
            playTone(NOTES[targetNote]);
            document.getElementById('chordNameDisplay').innerText = `NOTE: ${targetNote}`;
        } else {
            playFullChord(targetNote);
        }
    }

    function setPlayMode(m) {
        playMode = m;
        document.getElementById('singleBtn').classList.toggle('active', m === 'single');
        document.getElementById('majBtn').classList.toggle('active', m === 'major');
        document.getElementById('minBtn').classList.toggle('active', m === 'minor');
        if (m === 'single') document.getElementById('chordNameDisplay').innerText = "";
    }

    function handleInput(n) {
        if (playMode === 'single') {
            playTone(NOTES[n]);
            document.getElementById('chordNameDisplay').innerText = `NOTE: ${n.replace(/[0-9]/g, '')}`;
        } else {
            playFullChord(n);
        }

        const baseNote = n.replace(/[0-9]/g, '');
        if(baseNote === targetNote) {
            db.users[user] = (db.users[user] || 0) + 15;
            newTarget();
            save();
        }
    }

    function newTarget() {
        const options = ["C","D","E","F","G","A","B"];
        targetNote = options[Math.floor(Math.random() * options.length)];
        document.getElementById('targetDisplay').innerText = "TARGET: " + targetNote;
    }

    function save() {
        localStorage.setItem('psalmistDB', JSON.stringify(db));
        updateUI();
    }

    function updateUI() {
        document.getElementById('ninjaName').innerText = user;
        document.getElementById('xpDisp').innerText = (db.users[user] || 0) + " XP";
    }

    updateUI();
    newTarget();
</script>
</body>
</html>