<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dojo - Rhythm Mastery & Kraken Boss</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&display=swap" rel="stylesheet">
  <style>
    :root { --glow: #9370db; --accent: #4ade80; --boss: #ff416c; --bg: #02030a; }
    body { margin:0; background: var(--bg); color:#fff; text-align:center; font-family:'Orbitron'; transition: background 0.3s; overflow-x: hidden;}
    
    /* HUD & Navigation */
    .hud { background:rgba(255,255,255,0.05); padding:15px; border-bottom:2px solid var(--glow); display: flex; justify-content: space-between; align-items: center; }
    .btn-back { background:#222; color: #fff; padding: 10px; border-radius: 5px; cursor: pointer; border: none; font-family: 'Orbitron'; }
    
    /* Sensei Manual */
    .sensei-manual { background: linear-gradient(135deg, #1a1f3c, #0a1a3a); border: 2px solid #4f8cff; border-radius: 15px; padding: 20px; margin: 20px auto; max-width: 700px; display: flex; align-items: center; gap: 20px; text-align: left; box-shadow: 0 0 15px rgba(79, 140, 255, 0.3); }
    .sensei-avatar { font-size: 3rem; }
    .sensei-text h4 { margin: 0; color: var(--accent); text-transform: uppercase; }
    .sensei-text p { margin: 5px 0 0; font-size: 0.9rem; color: #cbd5e1; font-family: sans-serif; }

    /* Rhythm Grid */
    .grid { display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; max-width:800px; margin:20px auto; padding:10px; }
    .card { background:#1a1f3c; padding:20px; border:1px solid var(--glow); border-radius:10px; cursor:pointer; transition: 0.2s; }
    .card:hover { border-color: var(--accent); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(147, 112, 219, 0.3); }
    .card span { display: block; font-size: 0.7rem; color: #7dd3ff; margin-bottom: 5px; }
    .card b { font-size: 1.3rem; letter-spacing: 2px; }

    /* Daily Challenge & Boss Trigger */
    .challenge-box { background: rgba(74, 222, 128, 0.05); border: 1px dashed var(--accent); padding: 15px; border-radius: 10px; max-width: 800px; margin: 20px auto; }
    .btn-boss-trigger { background: linear-gradient(90deg, #7d2ae8, var(--boss)); color: #fff; padding: 15px 40px; border-radius: 50px; font-weight: 900; border: none; cursor: pointer; font-family: 'Orbitron'; margin-top: 20px; box-shadow: 0 0 20px rgba(255, 65, 108, 0.4); }

    /* BOSS OVERLAY (Matching Screenshot) */
    .overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); z-index:1000; }
    .boss-header { padding: 20px; border-bottom: 2px solid #ffd700; }
    .boss-hp-container { width: 90%; max-width: 1000px; margin: 20px auto; position: relative; }
    .bar-bg { width: 100%; height: 25px; background: #111; border-radius: 15px; border: 2px solid #333; overflow: hidden; margin-bottom: 10px; }
    .bar-fill { height: 100%; width: 100%; transition: 0.5s; }
    .kraken-fill { background: linear-gradient(90deg, #ff416c, #ff4b2b); box-shadow: 0 0 15px var(--boss); }
    .team-fill { background: linear-gradient(90deg, #4f8cff, #00d4ff); width: 0%; }
    
    .battle-split { display: flex; height: 60vh; }
    .side { width: 50%; border: 1px solid #111; padding: 20px; display: flex; flex-direction: column; align-items: center; }
    .p1-btn { background: #222; border: 1px solid #444; color: #fff; width: 80%; padding: 15px; margin: 5px; border-radius: 8px; font-family: 'Orbitron'; cursor: pointer; }
    .p1-btn:active { background: #4f8cff; }
  </style>
</head>
<body>

<div class="hud">
    <button onclick="window.location.href='index.html'" class="btn-back">â¬… HALL</button>
    <div>
        <span id="ninjaName">NINJA: Guest</span> | <span id="xpDisplay">0 XP</span>
    </div>
    <div style="width: 200px; height: 10px; background: #222; border-radius: 5px; overflow: hidden;">
        <div id="mainFill" style="height: 100%; width: 0%; background: var(--accent); transition: 0.5s;"></div>
    </div>
</div>

<div class="challenge-box">
    <h4 style="margin:0; color: var(--accent);">âš¡ DAILY RHYTHM CHALLENGE</h4>
    <p id="dailyText">Identify "The Pulse" 3 times to earn 200 XP!</p>
    <small id="dailyProgress">Progress: 0/3</small>
</div>

<div class="sensei-manual">
    <div class="sensei-avatar">ðŸ¥·</div>
    <div class="sensei-text">
        <h4 id="lessonTitle">Rhythm Dojo</h4>
        <p id="lessonContent">Master the 16 sacred patterns below. Press "Hear Pattern" to begin.</p>
    </div>
</div>

<button id="playBtn" onclick="playCurrentChallenge()" style="background:var(--accent); color:#000; padding:15px 30px; border-radius:10px; font-weight:900; border:none; cursor:pointer; font-family:'Orbitron';">ðŸ”Š HEAR PATTERN (3x)</button>

<div class="grid" id="rg"></div>

<button class="btn-boss-trigger" onclick="openBoss()">ðŸ‘¹ ENTER KRAKEN DEPTHS</button>

<div id="bossOverlay" class="overlay">
    <div class="boss-header">
        <h2 style="color:var(--boss); margin:0;">ðŸ‘¹ RHYTHM KRAKEN</h2>
        <div class="boss-hp-container">
            <div style="display:flex; justify-content: space-between; font-size: 0.7rem; color: var(--boss);"><span>KRAKEN HP</span><span id="hpText">1000/1000</span></div>
            <div class="bar-bg"><div id="bossHpFill" class="bar-fill kraken-fill"></div></div>
            
            <div style="display:flex; justify-content: space-between; font-size: 0.7rem; color: #4f8cff;"><span>TEAM SYNC XP</span><span id="teamText">0/1000</span></div>
            <div class="bar-bg"><div id="teamXpFill" class="bar-fill team-fill"></div></div>
        </div>
        <button onclick="playCurrentChallenge()" style="background:#ffd700; color:#000; padding:10px 30px; font-weight:900; border:none; border-radius:5px; cursor:pointer; font-family:'Orbitron';">ðŸ”Š HEAR ATTACK</button>
        <button onclick="closeBoss()" style="background:#222; color:#fff; border:none; padding:10px 20px; margin-left: 20px; cursor:pointer;">EXIT</button>
    </div>

    <div class="battle-split">
        <div class="side" style="background: rgba(79, 140, 255, 0.05);"><h3>P1</h3><div id="p1Options"></div></div>
        <div class="side" style="background: rgba(255, 65, 108, 0.05);"><h3>P2</h3><div id="p2Options"></div></div>
    </div>
</div>

<script>
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const PATS = [
    {name:"The Pulse", sym:"â™© â™©", p:[1, 1], lesson:"Quarter Notes: The heartbeat of music."},
    {name:"The Sprint", sym:"â™« â™«", p:[0.5, 0.5, 0.5, 0.5], lesson:"Eighth Notes: Two sounds per beat."},
    {name:"The Skip", sym:"â™© â™«", p:[1, 0.5, 0.5], lesson:"Long-short-short timing."},
    {name:"The Gallop", sym:"â™« â™©", p:[0.5, 0.5, 1], lesson:"Short-short-long build up."},
    {name:"The Swing", sym:"â™©. â™«", p:[1.5, 0.5], lesson:"A groovy, uneven jazz feel."},
    {name:"The Hook", sym:"â™« â™©.", p:[0.5, 1.5], lesson:"Common in pop music hooks."},
    {name:"The Waltz", sym:"â™© â™© â™©", p:[1, 1, 1], lesson:"The 3/4 time signature dance."},
    {name:"The Anchor", sym:"â™©. â™©.", p:[1.5, 1.5], lesson:"Heavy, grounded pulses."},
    {name:"The Square", sym:"â™© â™© â™© â™©", p:[1, 1, 1, 1], lesson:"Common 4/4 time foundation."},
    {name:"The Wave", sym:"â™« â™« â™« â™«", p:[0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], lesson:"Steady eighth note flow."},
    {name:"The March", sym:"â™« â™« â™©", p:[0.5, 0.5, 1], lesson:"Staccato build to a strong hit."},
    {name:"The Jazz", sym:"â™© â™« â™«", p:[1, 0.5, 0.5, 0.5, 0.5], lesson:"Syncopated modern jazz timing."},
    {name:"The Sync", sym:"â™© â™« â™© â™«", p:[1, 0.5, 1, 0.5], lesson:"The off-beat masterclass."},
    {name:"The Legend", sym:"â™©. â™« â™©. â™«", p:[1.5, 0.5, 1.5, 0.5], lesson:"Repetitive epic motif."},
    {name:"The Bounce", sym:"â™« â™© â™© â™«", p:[0.5, 1, 1, 0.5], lesson:"Fast ends with heavy middle."},
    {name:"The Finale", sym:"â™© â™« â™« â™©", p:[1, 0.5, 0.5, 1], lesson:"Complex closing phrase pattern."}
];

let db = JSON.parse(localStorage.getItem('psalmistDB')) || { users: {"Guest":0}, goal: 500 };
let currentUser = localStorage.getItem('activeUser') || "Guest";
let targetIdx = null;
let dailyCount = 0;
let bossHP = 1000;
let teamXP = 0;
let p1Ans = null, p2Ans = null;

function updateUI() {
    const xp = db.users[currentUser] || 0;
    document.getElementById('ninjaName').textContent = "NINJA: " + currentUser;
    document.getElementById('xpDisplay').textContent = xp + " XP";
    document.getElementById('mainFill').style.width = Math.min((xp/db.goal)*100, 100) + "%";
}

function playCurrentChallenge() {
    if (targetIdx === null) targetIdx = Math.floor(Math.random() * PATS.length);
    let time = audioCtx.currentTime + 0.1;
    for (let loop = 0; loop < 3; loop++) {
        PATS[targetIdx].p.forEach(dur => {
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.frequency.setValueAtTime(440, time);
            g.gain.setValueAtTime(0.2, time);
            g.gain.exponentialRampToValueAtTime(0.0001, time + 0.1);
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(time); osc.stop(time + 0.1);
            time += dur * 0.4;
        });
        time += 0.8;
    }
}

function selectRhythm(idx) {
    if(idx === targetIdx) {
        db.users[currentUser] += 20;
        document.getElementById('lessonTitle').textContent = "Success: " + PATS[idx].name;
        document.getElementById('lessonContent').textContent = PATS[idx].lesson;
        
        // Daily Challenge Logic
        if(PATS[idx].name === "The Pulse") {
            dailyCount++;
            document.getElementById('dailyProgress').textContent = `Progress: ${dailyCount}/3`;
            if(dailyCount === 3) { db.users[currentUser] += 200; alert("DAILY COMPLETE! +200 XP"); }
        }

        targetIdx = Math.floor(Math.random() * PATS.length);
        localStorage.setItem('psalmistDB', JSON.stringify(db));
        updateUI();
    } else {
        alert("Not quite! Listen again.");
    }
}

function openBoss() {
    document.getElementById('bossOverlay').style.display = 'block';
    bossHP = 1000; teamXP = 0; updateBossBars();
    const build = (id, pNum) => {
        const div = document.getElementById(id); div.innerHTML = "";
        PATS.slice(0, 4).forEach((r, i) => {
            const b = document.createElement('button'); b.className = "p1-btn";
            b.innerHTML = `<b>${r.name}</b><br>${r.sym}`;
            b.onclick = () => handleBossSync(pNum, i);
            div.appendChild(b);
        });
    };
    build('p1Options', 1); build('p2Options', 2);
}

function handleBossSync(p, i) {
    if(p === 1) p1Ans = i; else p2Ans = i;
    if(p1Ans !== null && p2Ans !== null) {
        if(p1Ans === targetIdx && p2Ans === targetIdx) { bossHP -= 200; teamXP += 100; }
        else if(p1Ans === targetIdx || p2Ans === targetIdx) { bossHP -= 50; teamXP += 20; }
        else { bossHP += 20; }
        p1Ans = p2Ans = null;
        updateBossBars();
        if(bossHP <= 0) { alert("KRAKEN DEFEATED!"); closeBoss(); }
    }
}

function updateBossBars() {
    document.getElementById('bossHpFill').style.width = (bossHP/1000*100) + "%";
    document.getElementById('teamXpFill').style.width = (teamXP/1000*100) + "%";
    document.getElementById('hpText').textContent = `${bossHP}/1000`;
    document.getElementById('teamText').textContent = `${teamXP}/1000`;
}

function closeBoss() { document.getElementById('bossOverlay').style.display = 'none'; db.users[currentUser] += teamXP; updateUI(); }

// Initialize Grid
PATS.forEach((p, i) => {
    const c = document.createElement('div'); c.className = 'card';
    c.innerHTML = `<span>${p.name}</span><b>${p.sym}</b>`;
    c.onclick = () => selectRhythm(i);
    document.getElementById('rg').appendChild(c);
});
updateUI();
</script>
</body>
</html>