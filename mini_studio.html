<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MINI_STUDIO // Neural Sequencer</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #05070a; --panel: rgba(10, 15, 25, 0.98); --blue: #4facfe; 
            --gold: #ffcc00; --green: #00ff88; --border: #1e2544; --red: #ff4b2b;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; background: var(--bg); color: #fff; font-family: 'Orbitron', sans-serif; 
            display: flex; flex-direction: column; min-height: 100vh;
            padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
            background-image: radial-gradient(circle at center, #0b1426 0%, #05070a 100%);
            overflow-x: hidden;
        }

        /* --- HUD --- */
        .hud-top {
            display: flex; justify-content: space-between; align-items: center; padding: 15px 20px;
            font-size: 0.65rem; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.3);
        }

        .main-stage { flex-grow: 1; width: 100%; max-width: 1100px; margin: 0 auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }

        /* --- Viz Terminal --- */
        .viz-terminal {
            background: #000; border: 1px solid var(--border); border-radius: 12px;
            height: 100px; position: relative; overflow: hidden;
        }
        canvas { width: 100%; height: 100%; }

        /* --- Config Grid --- */
        .config-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 10px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; border: 1px solid var(--border);
        }
        .config-box label { display: block; font-size: 0.5rem; color: #555; margin-bottom: 5px; letter-spacing: 1px; }

        .btn-util { 
            background: #0a0e17; border: 1px solid var(--border); color: var(--blue); 
            padding: 8px; font-family: 'Orbitron'; font-size: 0.6rem; cursor: pointer; border-radius: 4px;
            text-align: center; text-decoration: none; display: block;
        }

        /* --- Sequencer --- */
        .sequencer-scroll { width: 100%; overflow-x: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .track-row { 
            display: grid; grid-template-columns: 140px 1fr; gap: 15px; align-items: center;
            background: rgba(255,255,255,0.02); padding: 12px; border-radius: 8px; min-width: 850px; margin-bottom: 8px;
        }

        .track-meta { display: flex; flex-direction: column; gap: 5px; }
        .track-name { font-size: 0.65rem; color: var(--blue); font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .load-btn { font-size: 0.5rem; color: var(--gold); border: 1px solid; padding: 3px 6px; border-radius: 4px; cursor: pointer; }

        .step-grid { display: grid; grid-template-columns: repeat(16, 1fr); gap: 6px; }
        .step { 
            aspect-ratio: 1/1; background: #080a0f; border: 1px solid #1a1a1a; 
            cursor: pointer; border-radius: 5px; min-height: 40px;
        }
        .step.active { background: var(--blue); box-shadow: 0 0 10px var(--blue); border-color: transparent; }
        .step.playing { border: 2px solid var(--gold); }

        /* --- Footer Controls --- */
        .master-controls {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px; background: rgba(0,0,0,0.4); border-radius: 12px; margin-top: auto;
        }
        .btn-play { 
            background: var(--green); color: #000; border: none; padding: 15px 40px; 
            font-family: 'Orbitron'; font-weight: 900; cursor: pointer; border-radius: 50px;
            font-size: 0.8rem; letter-spacing: 2px;
        }
        .btn-play.active { background: var(--red); }

        /* --- Overlay --- */
        #briefing-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95);
            z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .briefing-card {
            max-width: 500px; padding: 30px; border: 1px solid var(--blue); background: var(--panel); border-radius: 20px;
            text-align: center; box-shadow: 0 0 30px rgba(79, 172, 254, 0.2);
        }

        @media (max-width: 600px) {
            .hud-top { padding: 15px 10px; }
            .btn-play { padding: 12px 25px; width: 100%; }
            .master-controls { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>

    <div id="briefing-overlay">
        <div class="briefing-card">
            <h2 style="color: var(--blue); font-size: 1rem; margin-top: 0;">MINI_STUDIO // INITIALIZATION</h2>
            <div style="text-align: left; font-size: 0.75rem; line-height: 1.6; color: #ccc; margin: 20px 0;">
                <p>• <b>NEURAL SEQUENCER:</b> 16-step temporal engine. Toggle steps to program triggers.</p>
                <p>• <b>SAMPLE LOADER:</b> Replace defaults with custom user audio (WAV/MP3).</p>
                <p>• <b>MOBILE INTEGRATION:</b> Safe-area support and touch-optimized sequencer grid.</p>
                <p>• <b>DATA ARCHIVE:</b> Save patterns as <b>.ninja</b> protocol files.</p>
            </div>
            <button class="btn-play" onclick="closeBriefing()" style="width: 100%;">START_ENGINE</button>
            <button class="btn-util" onclick="closeBriefing()" style="margin-top:10px; width:100%; border:none; color:#555;">SKIP_INSTRUCTIONS</button>
        </div>
    </div>

    <div class="hud-top">
        <div>PROTOCOL: MINI_STUDIO</div>
        <div style="display:flex; gap:10px;">
            <button class="btn-util" onclick="savePattern()">SAVE</button>
            <label class="btn-util" for="load-file" style="cursor:pointer">LOAD</label>
            <input type="file" id="load-file" style="display:none" accept=".ninja" onchange="loadPattern(this)">
            <a href="rhythm_hub.html" class="btn-util">[ EXIT ]</a>
        </div>
    </div>

    <div class="main-stage">
        <div class="viz-terminal">
            <canvas id="studio-viz"></canvas>
        </div>

        <div class="config-grid">
            <div class="config-box">
                <label>TEMPO_SYNC</label>
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="range" id="bpm-slider" min="60" max="200" value="120" oninput="updateTempo(this.value)" style="flex-grow:1; accent-color: var(--gold);">
                    <div style="font-size: 0.7rem; color: var(--gold); min-width:60px;"><span id="bpm-val">120</span> BPM</div>
                </div>
            </div>
            <div class="config-box">
                <label>METRO_CLOCK</label>
                <button class="btn-util" id="metro-toggle" onclick="toggleMetro()" style="width:100%">OFF</button>
            </div>
            <div class="config-box">
                <label>SYSTEM_DATA</label>
                <button class="btn-util" onclick="clearPattern()" style="width:100%; color: var(--red);">RESET_GRID</button>
            </div>
        </div>

        <div class="sequencer-scroll">
            <div id="sequencer-grid"></div>
        </div>

        <div class="master-controls">
            <button class="btn-play" id="play-btn" onclick="togglePlay()">START_ENGINE</button>
            <div style="font-size: 0.5rem; color: #444; letter-spacing: 2px;">STATUS: NEURAL_LINK_READY</div>
        </div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const analyzer = audioCtx.createAnalyser();
        const trackNames = ["KICK", "SNARE", "HI_HAT", "LEAD", "BASS"];
        
        let sampleBuffers = [null, null, null, null, null];
        let grid = Array(5).fill().map(() => Array(16).fill(false));
        let isPlaying = false, currentStep = 0, nextNoteTime = 0, tempo = 120, metroActive = false;

        function init() {
            const seq = document.getElementById('sequencer-grid');
            seq.innerHTML = '';
            trackNames.forEach((name, i) => {
                const row = document.createElement('div');
                row.className = 'track-row';
                row.innerHTML = `
                    <div class="track-meta">
                        <div class="track-name">
                            <span id="label-${i}">${name}</span>
                            <label class="load-btn" for="sample-${i}">LOAD</label>
                        </div>
                        <input type="file" id="sample-${i}" style="display:none" accept="audio/*" onchange="loadUserSample(${i}, this)">
                        <input type="range" min="0" max="1" step="0.01" value="0.7" id="vol-${i}" style="width:100%; height:3px; accent-color:var(--blue);">
                    </div>
                    <div class="step-grid" id="grid-${i}"></div>
                `;
                const sGrid = row.querySelector(`#grid-${i}`);
                for(let s=0; s<16; s++) {
                    const btn = document.createElement('div');
                    btn.className = grid[i][s] ? 'step active' : 'step';
                    btn.onclick = () => { if(audioCtx.state === 'suspended') audioCtx.resume(); grid[i][s] = !grid[i][s]; btn.classList.toggle('active'); };
                    sGrid.appendChild(btn);
                }
                seq.appendChild(row);
            });
            startVisualizer();
        }

        async function loadUserSample(idx, input) {
            const file = input.files[0];
            if(!file) return;
            const buffer = await audioCtx.decodeAudioData(await file.arrayBuffer());
            sampleBuffers[idx] = buffer;
            document.getElementById(`label-${idx}`).style.color = "var(--green)";
        }

        function triggerSound(idx, time) {
            const vol = parseFloat(document.getElementById(`vol-${idx}`)?.value || 0.7);
            if(sampleBuffers[idx]) {
                const src = audioCtx.createBufferSource();
                src.buffer = sampleBuffers[idx];
                const g = audioCtx.createGain();
                g.gain.setValueAtTime(vol, time);
                src.connect(g).connect(audioCtx.destination);
                src.connect(g).connect(analyzer);
                src.start(time);
            } else {
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                osc.frequency.setValueAtTime(idx === 0 ? 55 : 350 + (idx*100), time);
                if(idx === 0) osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.2);
                g.gain.setValueAtTime(vol * 0.4, time);
                g.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
                osc.connect(g).connect(audioCtx.destination);
                osc.connect(g).connect(analyzer);
                osc.start(time); osc.stop(time + 0.1);
            }
        }

        function toggleMetro() {
            metroActive = !metroActive;
            const btn = document.getElementById('metro-toggle');
            btn.innerText = metroActive ? "ON" : "OFF";
            btn.style.color = metroActive ? "var(--green)" : "var(--blue)";
        }

        function scheduler() {
            while (nextNoteTime < audioCtx.currentTime + 0.1) {
                for(let i=0; i<5; i++) { if(grid[i][currentStep]) triggerSound(i, nextNoteTime); }
                if(metroActive && currentStep % 4 === 0) {
                    const mOsc = audioCtx.createOscillator();
                    const mG = audioCtx.createGain();
                    mOsc.frequency.setValueAtTime(currentStep === 0 ? 1000 : 600, nextNoteTime);
                    mG.gain.setValueAtTime(0.05, nextNoteTime);
                    mG.gain.exponentialRampToValueAtTime(0.001, nextNoteTime + 0.05);
                    mOsc.connect(mG).connect(audioCtx.destination);
                    mOsc.start(nextNoteTime); mOsc.stop(nextNoteTime + 0.05);
                }
                updateVisualStep(currentStep);
                nextNoteTime += (60 / tempo / 4);
                currentStep = (currentStep + 1) % 16;
            }
            if (isPlaying) setTimeout(scheduler, 25);
        }

        function updateVisualStep(s) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('playing'));
            document.querySelectorAll('.track-row').forEach(row => {
                const step = row.querySelector(`.step:nth-child(${s+1})`);
                if(step) step.classList.add('playing');
            });
        }

        function togglePlay() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            isPlaying = !isPlaying;
            document.getElementById('play-btn').innerText = isPlaying ? "STOP_ENGINE" : "START_ENGINE";
            document.getElementById('play-btn').classList.toggle('active', isPlaying);
            if (isPlaying) { currentStep = 0; nextNoteTime = audioCtx.currentTime; scheduler(); }
        }

        function updateTempo(v) { tempo = v; document.getElementById('bpm-val').innerText = v; }
        function clearPattern() { grid = Array(5).fill().map(() => Array(16).fill(false)); init(); }
        function closeBriefing() { document.getElementById('briefing-overlay').style.display = 'none'; if(audioCtx.state==='suspended') audioCtx.resume(); }

        function savePattern() {
            const data = { grid, tempo };
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'session.ninja'; a.click();
        }

        function loadPattern(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = JSON.parse(e.target.result);
                grid = data.grid; tempo = data.tempo;
                document.getElementById('bpm-slider').value = tempo;
                updateTempo(tempo);
                init();
            };
            reader.readAsText(file);
        }

        function startVisualizer() {
            const canvas = document.getElementById('studio-viz');
            const ctx = canvas.getContext('2d');
            function render() {
                requestAnimationFrame(render);
                const data = new Uint8Array(analyzer.frequencyBinCount);
                analyzer.getByteTimeDomainData(data);
                ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
                ctx.strokeStyle = '#4facfe'; ctx.lineWidth = 2; ctx.beginPath();
                let slice = canvas.width / data.length; let x = 0;
                for(let i=0; i<data.length; i++) {
                    let v = data[i]/128.0; let y = v * (canvas.height/2);
                    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                    x += slice;
                }
                ctx.stroke();
            }
            render();
        }

        window.onload = () => {
            const canvas = document.getElementById('studio-viz');
            canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
            init();
        };
    </script>
</body>
</html>
