<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MINI_STUDIO // Neural Sequencer</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #020406; --panel: rgba(15, 20, 30, 0.95); --blue: #4facfe; 
            --gold: #ffcc00; --red: #ff4b2b; --border: rgba(79, 172, 254, 0.2); --green: #00ff88; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; background: var(--bg); color: #fff; font-family: 'Orbitron', sans-serif; 
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            padding: env(safe-area-inset-top) 10px 40px 10px;
            overflow-x: hidden;
        }

        header { width: 100%; max-width: 1100px; padding: 20px 0; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 900; letter-spacing: 2px; font-size: 0.9rem; }
        .logo span { color: var(--blue); }

        .viz-terminal {
            width: 100%; max-width: 1100px; height: 120px; background: #000;
            border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px;
            overflow: hidden; position: relative;
        }
        canvas { width: 100%; height: 100%; }

        .controls-grid {
            width: 100%; max-width: 1100px; display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px; margin-bottom: 20px;
        }

        .ctrl-box { background: var(--panel); padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
        .ctrl-box label { display: block; font-size: 0.5rem; color: #555; margin-bottom: 8px; letter-spacing: 1px; }

        .btn-action {
            width: 100%; padding: 12px; background: #0a0e17; border: 1px solid var(--border);
            color: var(--blue); font-family: 'Orbitron'; font-size: 0.6rem; border-radius: 6px;
            cursor: pointer; transition: 0.2s; text-align: center; text-decoration: none;
        }

        .sequencer-container { 
            width: 100%; max-width: 1100px; background: var(--panel); 
            border: 1px solid var(--border); border-radius: 12px; padding: 20px;
            overflow-x: auto;
        }

        .track-row { display: grid; grid-template-columns: 150px 1fr; gap: 20px; align-items: center; margin-bottom: 12px; min-width: 850px; }
        .track-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .track-name { font-size: 0.65rem; font-weight: 700; color: var(--blue); }
        .load-btn { font-size: 0.45rem; color: var(--gold); border: 1px solid var(--gold); padding: 2px 5px; border-radius: 3px; cursor: pointer; }

        .step-grid { display: grid; grid-template-columns: repeat(16, 1fr); gap: 6px; }
        .step { 
            aspect-ratio: 1/1; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 4px; cursor: pointer; min-height: 35px;
        }
        .step.active { background: var(--blue); box-shadow: 0 0 10px var(--blue); border: none; }
        .step.playing { border: 2px solid var(--gold); }

        #mission-briefing {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .brief-card {
            max-width: 500px; background: var(--panel); border: 1px solid var(--blue);
            padding: 30px; border-radius: 16px; text-align: center;
        }

        .btn-main {
            background: var(--blue); color: #000; border: none; padding: 15px 40px;
            font-family: 'Orbitron'; font-weight: 900; border-radius: 50px; cursor: pointer; width: 100%;
        }
    </style>
</head>
<body>

    <div id="mission-briefing">
        <div class="brief-card">
            <h2 style="color: var(--blue); font-size: 1rem;">MINI_STUDIO // INITIALIZATION</h2>
            <p style="font-size: 0.75rem; text-align: left; color: #ccc; line-height: 1.6; margin: 20px 0;">
                • Program the 16-step grid to trigger neural audio pulses.<br>
                • Load custom WAV/MP3 samples to customize your tracks.<br>
                • Use the SKIP button to bypass these instructions.
            </p>
            <button class="btn-main" onclick="closeBriefing()">START_ENGINE</button>
            <button class="btn-action" onclick="closeBriefing()" style="margin-top:10px; border:none; color:#555;">SKIP_INSTRUCTIONS</button>
        </div>
    </div>

    <header>
        <div class="logo">MINI_<span>STUDIO</span></div>
        <div style="display:flex; gap:10px;">
            <button class="btn-action" onclick="savePattern()">SAVE</button>
            <label class="btn-action" for="load-file">LOAD</label>
            <input type="file" id="load-file" style="display:none" accept=".ninja" onchange="loadPattern(this)">
        </div>
    </header>

    <div class="viz-terminal"><canvas id="visualizer"></canvas></div>

    <div class="controls-grid">
        <div class="ctrl-box">
            <label>TEMPO</label>
            <input type="range" id="bpm-slider" min="60" max="200" value="120" oninput="updateTempo(this.value)" style="width:100%;">
            <div id="bpm-val" style="font-size:0.7rem; color:var(--gold); margin-top:5px;">120 BPM</div>
        </div>
        <div class="ctrl-box">
            <label>ENGINE</label>
            <button class="btn-main" id="play-btn" onclick="togglePlay()" style="padding:10px; font-size:0.6rem;">START</button>
        </div>
    </div>

    <div class="sequencer-container"><div id="sequencer-grid"></div></div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const analyzer = audioCtx.createAnalyser();
        const trackNames = ["KICK", "SNARE", "HI_HAT", "LEAD", "BASS"];
        let sampleBuffers = [null, null, null, null, null];
        let grid = Array(5).fill().map(() => Array(16).fill(false));
        let isPlaying = false, currentStep = 0, nextNoteTime = 0, tempo = 120;

        function init() {
            const seq = document.getElementById('sequencer-grid');
            seq.innerHTML = '';
            trackNames.forEach((name, i) => {
                const row = document.createElement('div');
                row.className = 'track-row';
                row.innerHTML = `
                    <div class="track-info">
                        <div class="track-header"><span class="track-name" id="n-${i}">${name}</span><label class="load-btn" for="s-${i}">LOAD</label></div>
                        <input type="file" id="s-${i}" style="display:none" accept="audio/*" onchange="loadSample(${i}, this)">
                        <input type="range" min="0" max="1" step="0.01" value="0.7" id="v-${i}" style="width:100%;">
                    </div>
                    <div class="step-grid" id="g-${i}"></div>
                `;
                const g = row.querySelector(`#g-${i}`);
                for(let s=0; s<16; s++) {
                    const b = document.createElement('div');
                    b.className = grid[i][s] ? 'step active' : 'step';
                    b.onclick = () => { if(audioCtx.state==='suspended') audioCtx.resume(); grid[i][s]=!grid[i][s]; b.classList.toggle('active'); };
                    g.appendChild(b);
                }
                seq.appendChild(row);
            });
            drawVisualizer();
        }

        async function loadSample(idx, input) {
            const file = input.files[0];
            if(!file) return;
            const buffer = await audioCtx.decodeAudioData(await file.arrayBuffer());
            sampleBuffers[idx] = buffer;
            document.getElementById(`n-${idx}`).style.color = "var(--green)";
        }

        function triggerSound(idx, time) {
            const vol = parseFloat(document.getElementById(`v-${idx}`).value);
            if(sampleBuffers[idx]) {
                const s = audioCtx.createBufferSource(); s.buffer = sampleBuffers[idx];
                const g = audioCtx.createGain(); g.gain.setValueAtTime(vol, time);
                s.connect(g).connect(audioCtx.destination); s.connect(g).connect(analyzer);
                s.start(time);
            } else {
                const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                o.frequency.setValueAtTime(idx === 0 ? 55 : 200 + (idx*100), time);
                g.gain.setValueAtTime(vol*0.3, time); g.gain.exponentialRampToValueAtTime(0.001, time+0.1);
                o.connect(g).connect(audioCtx.destination); o.connect(g).connect(analyzer);
                o.start(time); o.stop(time+0.1);
            }
        }

        function scheduler() {
            while (nextNoteTime < audioCtx.currentTime + 0.1) {
                for(let i=0; i<5; i++) { if(grid[i][currentStep]) triggerSound(i, nextNoteTime); }
                updateVisual(currentStep);
                nextNoteTime += (60 / tempo / 4);
                currentStep = (currentStep + 1) % 16;
            }
            if (isPlaying) setTimeout(scheduler, 25);
        }

        function updateVisual(s) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('playing'));
            document.querySelectorAll('.track-row').forEach(row => {
                const step = row.querySelector(`.step:nth-child(${s+1})`);
                if(step) step.classList.add('playing');
            });
        }

        function togglePlay() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            isPlaying = !isPlaying;
            document.getElementById('play-btn').innerText = isPlaying ? "STOP" : "START";
            if (isPlaying) { currentStep = 0; nextNoteTime = audioCtx.currentTime; scheduler(); }
        }

        function updateTempo(v) { tempo = v; document.getElementById('bpm-val').innerText = v + " BPM"; }
        function closeBriefing() { document.getElementById('mission-briefing').style.display='none'; }
        
        function savePattern() {
            const blob = new Blob([JSON.stringify({grid, tempo})], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'studio.ninja'; a.click();
        }

        function loadPattern(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = JSON.parse(e.target.result);
                grid = data.grid; tempo = data.tempo; init();
            };
            reader.readAsText(input.files[0]);
        }

        function drawVisualizer() {
            const canvas = document.getElementById('visualizer');
            const ctx = canvas.getContext('2d');
            function render() {
                requestAnimationFrame(render);
                const data = new Uint8Array(analyzer.frequencyBinCount);
                analyzer.getByteTimeDomainData(data);
                ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
                ctx.strokeStyle = '#4facfe'; ctx.lineWidth = 2; ctx.beginPath();
                let slice = canvas.width / data.length; let x = 0;
                for(let i=0; i<data.length; i++) {
                    let v = data[i]/128.0; let y = v * (canvas.height/2);
                    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                    x += slice;
                }
                ctx.stroke();
            }
            render();
        }

        window.onload = () => {
            const c = document.getElementById('visualizer');
            c.width = c.offsetWidth; c.height = c.offsetHeight;
            init();
        };
    </script>
</body>
</html>
